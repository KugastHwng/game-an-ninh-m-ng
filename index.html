<!DOCTYPE html>

<html lang="vi">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>HÃ nh trÃ¬nh an toÃ n máº¡ng</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap');
body { margin:0; font-family:'Poppins', sans-serif; overflow:auto; background: linear-gradient(#6bd5ff, #b9f1ff); }
/* Sá»­a lá»—i ná»n xanh cá»§a quiz */
#quiz {
    display: none;
    flex-direction: column;
    justify-content: center; 
    align-items: center;
    height: 100vh;
    width: 100vw;
    background: linear-gradient(#6bd5ff, #b9f1ff); 
}
/* Thu nhá» poster Ä‘á»ƒ khÃ´ng bá»‹ quÃ¡ to */
#poster img {
    max-width: 90%;
    max-height: 80vh;
    object-fit: contain;
}

/* INTRO */
#introContainer,#outroScreen { width:100vw; height:100vh; display:flex; flex-direction:column; justify-content:center; align-items:center; text-align:center; padding:20px; box-sizing:border-box; }
#outroScreen { display:none; flex-direction:column; justify-content:center; align-items:center; text-align:center; animation: bgFade 5s ease-in-out infinite; }

#introText { max-width:800px; color:#004760; font-size:20px; line-height:1.6; }

/* Name input */
#nameBox { display:none; margin-top:20px; text-align:center; }
#playerName { padding:10px; font-size:18px; border-radius:10px; border:2px solid #5ab4ff; }

/* HÆ°á»›ng dáº«n trÃªn thÃ¡p */
#towerGuide { text-align:center; font-size:20px; color:#004b70; margin-top:20px; display:none; }

/* GAME */
#gameTitle { display:none; text-align:center; margin-top:20px; color:#0077c8; }
.game-area { display:none; flex-direction:row; justify-content:center; align-items:flex-end; gap: 40px; margin-top: 60px; position:relative; height:400px; }
.tower { width:120px; height:150px; border-radius:20px 20px 0 0; display:flex; flex-direction:column; align-items:center; justify-content:flex-end; cursor:pointer; position:relative; box-shadow:0 8px 20px rgba(0,0,0,0.25); transition:0.3s; }
.tower:hover { transform: scale(1.05); }
.roof { width:120px; height:40px; clip-path: polygon(50% 0%, 100% 100%, 0% 100%); margin-bottom:0; box-shadow:0 4px 10px rgba(0,0,0,0.3); }

#tower1 { background:#ffe5b4; } #tower1 .roof { background:#ff7f50; }
#tower2 { background:#d0f0c0; } #tower2 .roof { background:#32cd32; }
#tower3 { background:#c0d6f0; } #tower3 .roof { background:#1e90ff; }
#tower4 { background:#f4c2c2; } #tower4 .roof { background:#ff4500; }

.character { width:50px; height:50px; background:#ffeb3b; border-radius:50%; position:absolute; display:flex; align-items:center; justify-content:center; font-size:24px; z-index:5; transition:0.3s; }

/* POPUP */
.popup { position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:white; padding:20px; border-radius:15px; box-shadow:0 8px 25px rgba(0,0,0,0.35); display:none; z-index:10; width:350px; max-width:90vw; }
.popup h2 { margin-top:0; color:#0077c8; }
.popup button { width:100%; padding:12px; background:#00a8ff; color:white; border:none; border-radius:8px; font-weight:bold; cursor:pointer; margin-top:5px; }
.popup button:hover { background:#0077c8; }

.tower.level1 { box-shadow:0 0 10px 3px gold; height:200px; }
.tower.level2 { box-shadow:0 0 15px 5px orange; height:250px; }
.tower.level3 { box-shadow:0 0 25px 8px red; height:300px; }

/* small styles for video/quiz popups */
#congratsPopup .line { margin:8px 0; color:#073b4c; }
#videoPopup video { width:100%; height:auto; border-radius:8px; background:#000; }
.quiz-answers { margin-top:12px; display:flex; flex-direction:column; gap:8px; }
.quiz-answers button, .quiz-answers .submit-btn { width:100%; padding:10px; border-radius:8px; border:none; cursor:pointer; font-weight:600; }
.checkbox-row { display:flex; flex-direction:column; gap:6px; margin-top:8px; text-align:left; }

/* Gradient animation outro */
@keyframes bgFade {
  0% { background: linear-gradient(#6bd5ff, #b9f1ff); }
  50% { background: linear-gradient(#b9f1ff, #6bd5ff); }
  100% { background: linear-gradient(#6bd5ff, #b9f1ff); }
}

/* QR TO BÃŠN PHáº¢I */
#bigQR {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 9999;
}
#bigQR img {
    width: 220px;
    height:auto;
    border-radius:12px;
    box-shadow:0 0 20px rgba(0,0,0,0.25);
}
.hide-big-qr #bigQR { display:none!important; }


@media (max-width: 600px) {
  #bigQR img {
    width: 40px !important;
  }
  #bigQR {
    bottom: 10px !important;
    right: 10px !important;
  }
}


/* MOBILE FIX â€“ resize towers on small screens */
@media (max-width: 480px) {
  .tower {
    width: 100px !important;
    height: 150px !important;
    border-radius: 20px !important;
  }
  .tower-container, .towers-row {
    gap: 20px !important;
    padding: 15px 0 !important;
  }
}
@media (max-width: 390px) {
  .tower {
    width: 75px !important;
    height: 155px !important;
  }
}

</style>
<style>
#leaderboard table {
  border-collapse: collapse;
  width: 80%;
  margin: 20px auto;
  background: white;
  border-radius: 12px;
  overflow:auto;
}
#leaderboard th {
  background: #4aa3ff;
  color: white;
  padding: 12px;
  font-size: 18px;
}
#leaderboard td {
  padding: 10px;
  text-align: center;
  font-size: 16px;
}
#leaderboard tr:nth-child(even) { background: #f2f7ff; }
.medal { font-size:22px; }
</style>
<style>
#top50Btn {
 position: fixed;
 top: 10px;
 right: 10px; ÄÃ³ng
 padding: 6px 10px;
 background:#007bff;
 color:white;
 border:none;
 border-radius:8px;
 font-size:14px;
 display:none;
 z-index:9999;
}
</style>
<!-- Firebase CDN -->
<script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js"></script>
<script>
  const firebaseConfig = {
    apiKey: "AIzaSyBp-d-t6eQ0GuXTehgoPD-h99xB1YUg2Lc",
    authDomain: "an-toan-internet.firebaseapp.com",
    projectId: "an-toan-internet",
    storageBucket: "an-toan-internet.firebasestorage.app",
    messagingSenderId: "32947390990",
    appId: "1:32947390990:web:71ec5d85e6b0cef78d4a5f",
    measurementId: "G-X7HLNTRBZG"
  };
  const app = firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
</script>

<style>
html,body { margin:0; padding:0; overflow:auto; height:100%; }
.game-area { transform: scale(0.9); transform-origin: top center; }
@media(max-width:600px){
  .game-area { transform: scale(0.75); }
}
</style>
</head>
<body>
<!-- QR TO CHO TRANG Äáº¦U TIÃŠN -->
<div id="bigQR">
<img alt="QR Game" src="qr_game_link.png"/>
</div>
<button id="top50Btn" onclick="showTop50()">TOP 50</button>
<!-- QR GAME -->
<div id="smallQR" style="display:none; position:fixed; top:1px; right:1px; z-index:9999;">
<img src="qr_game_link.png" style="width:60px; height:auto; border-radius:8px;"/>
</div>
<!-- === NHáº C Ná»€N === -->
<audio id="bgMusic" loop="">
<source src="music.mp3" type="audio/mpeg"/>
</audio>
<!-- === Ã‚M THANH ÄÃšNG â€“ SAI === -->
<audio id="correctSound">
<source src="correct.mp3" type="audio/mpeg"/>
</audio>
<audio id="wrongSound">
<source src="wrong.mp3" type="audio/mpeg"/>
</audio>
<!-- INTRO -->
<div id="introContainer">
<div id="introText"></div>
<div id="nameBox" style="margin-top:20px; text-align:center;">
<button onclick="startGame()" style="padding:10px 20px;border-radius:10px;">
      Báº¯t Ä‘áº§u
    </button>
</div>
</div>
<!-- NÃšT HIá»‚N THá»Š HÆ¯á»šNG DáºªN -->
<div style="text-align:center; margin-top:10px;">
<button id="towerGuideBtn" onclick="loadMyRank()" style="padding:10px 16px; background:#00a8ff; color:#fff; border:none; border-radius:8px; cursor:pointer; font-weight:600;">HÆ°á»›ng dáº«n ThÃ¡p</button>
</div>
<!-- POPUP HÆ¯á»šNG DáºªN -->
<div id="towerGuidePopup" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:50; justify-content:center; align-items:center; padding:20px; display:flex;">
<div style="background:#fff; max-width:700px; width:100%; border-radius:12px; padding:20px; box-shadow:0 12px 35px rgba(0,0,0,0.35); overflow:auto; max-height:80vh;">
<h2 style="margin-top:0; color:#0077c8;">HÆ°á»›ng dáº«n sá»­ dá»¥ng â€” 4 tÃ²a thÃ¡p</h2>
<p><strong>Má»¥c tiÃªu:</strong> Tráº£ lá»i Ä‘Ãºng cÃ¡c cÃ¢u há»i Ä‘á»ƒ nÃ¢ng cáº¥p 4 tÃ²a thÃ¡p lÃªn má»©c tá»‘i Ä‘a.</p>
<ol style="text-align:left; padding-left:18px;">
<li><strong>Chá»n tÃ²a thÃ¡p :</strong> Nháº¥p vÃ o tÃ²a thÃ¡p báº¡n muá»‘n tráº£ lá»i.</li>
<li><strong>Tráº£ lá»i cÃ¢u há»i:</strong> Má»—i thÃ¡p chá»‰ cÃ³ 1 cÃ¢u há»i, chá»n 1 trong 3 Ä‘Ã¡p Ã¡n.</li>
<li><strong>NÃ¢ng cáº¥p :</strong> Náº¿u Ä‘Ãºng, thÃ¡p sáº½ Ä‘áº¡t má»©c tá»‘i Ä‘a ngay.</li>
<li><strong>Thá»­ láº¡i khi sai:</strong> Náº¿u sai, cÃ³ thÃ´ng bÃ¡o, báº¡n cÃ³ thá»ƒ thá»­ láº¡i.</li>
<li><strong>HoÃ n thÃ nh má»™t pháº§n cá»§a hoáº¡t Ä‘á»™ng 1:</strong> Khi cáº£ 4 thÃ¡p Ä‘á»u Ä‘áº¡t má»©c tá»‘i Ä‘a, mÃ n khÃ¡c sáº½ xuáº¥t hiá»‡n.</li>
</ol>
<div style="text-align:right; margin-top:12px;">
<button onclick="closeTowerGuide()" style="padding:10px 16px; background:#ff6b6b; color:#fff; border:none; border-radius:8px; cursor:pointer; font-weight:600;">ÄÃ³ng</button>
</div>
</div>
</div>
<!-- HÆ°á»›ng dáº«n trÃªn thÃ¡p -->
<div id="towerGuide" style="display:none;">
  Chá»n vÃ o má»—i tÃ²a thÃ¡p â€” má»—i tÃ²a tÆ°á»£ng trÆ°ng cho má»™t tÃ i khoáº£n cá»§a An. Nháº¥p vÃ o thÃ¡p Ä‘á»ƒ Ä‘áº·t máº­t kháº©u máº¡nh!
</div>
<!-- GAME -->
<h1 id="gameTitle">Mini Game: Chá»n máº­t kháº©u máº¡nh Ä‘á»ƒ nÃ¢ng cáº¥p thÃ¡p</h1>
<div class="game-area" id="gameArea">
<div class="tower" id="tower1"><div class="roof"></div></div>
<div class="tower" id="tower2"><div class="roof"></div></div>
<div class="tower" id="tower3"><div class="roof"></div></div>
<div class="tower" id="tower4"><div class="roof"></div></div>
<div class="character" id="character">ğŸ˜Š</div>
</div>
<!-- POPUP -->
<div class="popup" id="popup">
<h2 id="questionTitle">Chá»n máº­t kháº©u</h2>
<div id="answers"></div>
</div>
<!-- POPUP CUá»I THÃP -->
<div class="popup" id="finalPopup">
<h2>ChÃºc má»«ng!</h2>
<p>Báº¡n Ä‘Ã£ giÃºp An Ä‘áº·t máº­t kháº©u máº¡nh, nhÆ°ng Ä‘á»ƒ sau nÃ y An khÃ´ng Ä‘áº·t máº­t kháº©u yáº¿u ná»¯a, báº¡n nÃªn cho An 1 sá»‘ lá»i khuyÃªn.</p>
<button id="nextGameBtn">ÄÆ°á»£c thÃ´i</button>
</div>
<!-- POPUP Lá»œI KHUYÃŠN -->
<div class="popup" id="advicePopup">
<h2 id="adviceQuestion">CÃ¢u há»i</h2>
<div id="adviceAnswers"></div>
</div>
<!-- OUTRO -->
<div id="outroScreen">
<h1 id="outroTitle" style="opacity:0; transition:opacity 1s;">Thank for playing!</h1>
<p id="outroText" style="opacity:0; transition:opacity 1s;">Báº¡n Ä‘Ã£ hoÃ n thÃ nh trÃ² chÆ¡i.HÃ£y chia sáº» cho báº¡n bÃ¨ cÃ¹ng chÆ¡i nhÃ©.Háº¹n gáº·p láº¡i!<br/>Game Ä‘Æ°á»£c táº¡o bá»Ÿi Táº¡ Duy HÆ°ng vÃ  LÃª HoÃ ng QuÃ¢n.</p>
<div id="outroCharacter" style="width:80px; height:80px; background:#ffeb3b; border-radius:50%; margin-top:30px; display:flex; justify-content:center; align-items:center; font-size:36px; opacity:0; transition:opacity 1s;">ğŸ˜Š</div>
</div>
<!-- ======= NEW: CONGRATS + VIDEO + QUIZ POPUPS (THÃŠM Má»šI, KHÃ”NG Sá»¬A GAME) ======= -->
<!-- Congratulation popup (shown when showOutro is called) -->
<div class="popup" id="congratsPopup" style="display:none; width:420px;">
<h2>ChÃºc má»«ng â€” Báº¡n Ä‘Ã£ hoÃ n thÃ nh trÃ² chÆ¡i!</h2>
<p class="line">Báº¡n Ä‘Ã£ giÃºp An cáº£i thiá»‡n báº£o máº­t. ChÃºng ta sáº½ chuyá»ƒn sang hoáº¡t Ä‘á»™ng 2, hÃ£y xem video Ä‘á»ƒ hiá»ƒu thÃªm vá» cÃ¡c tÃ¬nh huá»‘ng lá»«a Ä‘áº£o nhÃ©.</p>
<button id="watchVideoBtn">Xem video hÆ°á»›ng dáº«n</button>
<button id="skipToQuizBtn" style="background:#ff6b6b; margin-top:8px;">Bá» qua video â€” Tráº£ lá»i cÃ¢u há»i</button>
</div>
<!-- Video popup -->
<div class="popup" id="videoPopup" style="display:none; width:760px; max-width:95vw;">
<h2>Video minh há»a tÃ¬nh huá»‘ng lá»«a Ä‘áº£o</h2>
<video controls="" id="lessonVideo">
<source src="video.mp4" type="video/mp4"/>
    TrÃ¬nh duyá»‡t cá»§a báº¡n khÃ´ng há»— trá»£ tháº» video.
  </video>
<button id="skipVideoBtn" style="margin-top:10px; background:#ff6b6b;">Bá» qua video</button>
</div>
<!-- Quiz popup (4 cÃ¢u há»i) -->
<div class="popup" id="quizPopup" style="display:none; width:600px; max-width:95vw;">
<h2 id="quizTitle">BÃ i kiá»ƒm tra nhanh</h2>
<div id="quizBody" style="margin-top:8px; text-align:left;">
<!-- Ná»™i dung cÃ¢u há»i sáº½ Ä‘Æ°á»£c chÃ¨n báº±ng JS -->
</div>
<div style="margin-top:12px;">
<button id="nextQuizBtn" style="background:#00a8ff;">Tiáº¿p tá»¥c</button>
</div>
</div>
<div id="activity3Screen" style="display:none; flex-direction:column; justify-content:center; align-items:center; height:100vh; padding:20px; text-align:center; background:#87CEFA;">
<h1>Hoáº¡t Ä‘á»™ng 3</h1>
<p style="font-size:20px; color:#0077c8; margin-bottom:15px;">
    Lan Ä‘ang lÃ m poster tuyÃªn truyá»n an toÃ n máº¡ng nhÆ°ng báº¡n áº¥y chá»‰ má»›i xong pháº§n trÃ¬nh bÃ y, báº¡n hÃ£y giÃºp báº¡n áº¥y pháº§n ná»™i dung nhÃ©.
  </p>
<button id="startQuizBtn" style="margin-top:20px; padding:10px 16px; background:#00a8ff; color:#fff; border:none; border-radius:8px; cursor:pointer;">OK</button>
</div>
<div id="quiz" style="display:none; flex-direction:column; align-items:center; gap:12px; margin-top:20px;">
<div id="question" style="font-size:20px; font-weight:600;"></div>
<div id="options" style="display:flex; flex-direction:column; gap:10px;"></div>
</div>
<div id="poster" style="display:none; margin-top:20px; font-size:18px;">
<img alt="Poster" src="posternhÃ©.png" style="max-width:90%; border-radius:12px;"/>
</div>
<!-- ========================================================================== -->
<script>
// --- INTRO ---
const introLines=["Báº¡n lÃ  1 nhÃ  thÃ¡m hiá»ƒm internet...","Trong lÃºc thÃ¡m hiá»ƒm báº¡n gáº·p An â€“ 1 ngÆ°á»i Ä‘ang bá»‹ nhá»¯ng tÃªn hacker Ä‘Ã¡nh cáº¯p thÃ´ng tin...","Nhiá»‡m vá»¥ cá»§a báº¡n lÃ  giÃºp An Ä‘áº·t láº¡i máº­t kháº©u!"];
let lineIndex=0,charIndex=0;
const introText=document.getElementById("introText");
const nameBoxEl=document.getElementById("nameBox");

function typeIntro(){
  introText.innerHTML = ""; 
  lineIndex=0; charIndex=0;

  function typing(){
    if(lineIndex<introLines.length){
      if(charIndex<introLines[lineIndex].length){
        introText.innerHTML+=introLines[lineIndex].charAt(charIndex);
        charIndex++;
        setTimeout(typing,40);
      } else {
        introText.innerHTML+="<br><br>";
        lineIndex++; charIndex=0;
        setTimeout(typing,500);
      }
    } else {
      nameBoxEl.style.display="block";
    }
  }

  typing();
}

// KHÃ”NG CHáº Y INTRO KHI LOAD TRANG Ná»®A
// window.onload = typeIntro;

// --- NHáº C ---
const bgMusic=document.getElementById("bgMusic");
const correctSound=document.getElementById("correctSound");
const wrongSound=document.getElementById("wrongSound");
let bgStart=false;

document.addEventListener("click",()=>{
  if(!bgStart){
    bgMusic.volume=0.5;
    bgMusic.play().catch(()=>{});
    bgStart=true;
  }
});

// --- GAME DATA ---
const towersData = {
  tower1: [{question: "Chá»n máº­t kháº©u máº¡nh.", answers: [{ text: "12345", correct: false },{ text: "Huy3#2025", correct: true },{ text: "abcdef", correct: false }]}],
  tower2: [{question: "Chá»n máº­t kháº©u cÃ³ sá»‘ vÃ  chá»¯ viáº¿t hoa.", answers: [{ text: "Pass1234", correct: true },{ text: "abcdefg", correct: false },{ text: "Password", correct: false }]}],
  tower3: [{question: "Chá»n máº­t kháº©u cÃ³ chá»¯ hoa, chá»¯ thÆ°á»ng,sá»‘ vÃ  kÃ½ tá»± Ä‘áº·c biá»‡t.", answers: [{ text: "ABCDEFG", correct: false },{ text: "1234567", correct: false },{ text: "Hoctap@1235", correct: true }]}],
  tower4: [{question: "Chá»n máº­t kháº©u Ä‘á»§ 8 kÃ½ tá»± trá»Ÿ lÃªn.", answers: [{ text: "12a424a", correct: false },{ text: "chamchi@!", correct: true },{ text: "3d5cc2", correct: false }]}]
};

const towers=document.querySelectorAll('.tower');
const popup=document.getElementById('popup');
const questionTitle=document.getElementById('questionTitle');
const answersDiv=document.getElementById('answers');
const character=document.getElementById('character');
const gameArea=document.getElementById('gameArea');
const gameTitle=document.getElementById('gameTitle');
const towerGuide=document.getElementById('towerGuide');
const finalPopup=document.getElementById('finalPopup');
const advicePopup=document.getElementById('advicePopup');
const adviceQuestionEl=document.getElementById('adviceQuestion');
const adviceAnswersDiv=document.getElementById('adviceAnswers');
const outroScreen=document.getElementById('outroScreen');
const outroChar=document.getElementById('outroCharacter');

let currentTower=null;
let currentLevel={tower1:0,tower2:0,tower3:0,tower4:0};

function startGame() {
  // áº¨n intro
  document.getElementById('introContainer').style.display = "none";

  // Hiá»‡n cÃ¡c pháº§n cá»§a game
  towerGuide.style.display = "block";
  gameTitle.style.display = "block";
  gameArea.style.display = "flex";
}

towers.forEach(tower=>{
  tower.addEventListener('click',()=>{
    currentTower=tower.id;
    const rect=tower.getBoundingClientRect();
    const areaRect=gameArea.getBoundingClientRect();
    const x=rect.left-areaRect.left+rect.width/2-character.offsetWidth/2;
    const y=-character.offsetHeight;
    character.style.left=x+'px';
    character.style.top=y+'px';
    showTowerQuestion(currentTower);
  });
});

function showTowerQuestion(towerId){
  const level=currentLevel[towerId];
  if(level>=1){ checkAllTowersCompleted(); return; }
  const q=towersData[towerId][0];
  questionTitle.textContent=q.question;
  answersDiv.innerHTML="";
  q.answers.forEach(ans=>{
    const btn=document.createElement('button');
    btn.textContent=ans.text;
    btn.onclick=()=>checkTowerAnswer(ans.correct);
    answersDiv.appendChild(btn);
  });
  popup.style.display='block';
}

function checkTowerAnswer(isCorrect){
  if(isCorrect){
    correctSound.currentTime=0; correctSound.play();
    alert("Chá»n Ä‘Ãºng! ThÃ¡p Ä‘Æ°á»£c nÃ¢ng cáº¥p ğŸ‰");
    const towerEl=document.getElementById(currentTower);
    currentLevel[currentTower]=3;
    towerEl.classList.add("level3");
  } else { wrongSound.currentTime=0; wrongSound.play(); alert("Máº­t kháº©u yáº¿u, thá»­ láº¡i ğŸ˜¢"); }
  popup.style.display='none';
  checkAllTowersCompleted();
}

function checkAllTowersCompleted(){
  const allDone=Object.values(currentLevel).every(l=>l>=1);
  if(allDone){ finalPopup.style.display='block'; }
  
}


document.getElementById('nextGameBtn').onclick=()=>{ finalPopup.style.display='none'; showAdviceGame(); };

// ---- GAME Lá»œI KHUYÃŠN ----
const adviceQuestions=[
  {q:"Khi Ä‘áº·t máº­t kháº©u, báº¡n cáº§n ___ Ä‘á»ƒ báº£o máº­t tá»‘t hÆ¡n.",answers:[
    {text:"sá»­ dá»¥ng chá»¯ hoa, chá»¯ thÆ°á»ng, sá»‘ vÃ  kÃ½ tá»± Ä‘áº·c biá»‡t",correct:true},
    {text:"chá»‰ dÃ¹ng sá»‘",correct:false},
    {text:"dÃ¹ng tÃªn mÃ¬nh",correct:false}]},
  {q:"Máº­t kháº©u nÃªn cÃ³ Ã­t nháº¥t ___ kÃ½ tá»±.",answers:[
    {text:"4 kÃ½ tá»±",correct:false},
    {text:"8 kÃ½ tá»±",correct:true},
    {text:"2 kÃ½ tá»±",correct:false}]},
  {q:"KhÃ´ng nÃªn sá»­ dá»¥ng ___ trong máº­t kháº©u.",answers:[
    {text:"tÃªn ngÆ°á»i thÃ¢n hoáº·c ngÃ y sinh",correct:true},
    {text:"kÃ½ tá»± Ä‘áº·c biá»‡t",correct:false},
    {text:"chá»¯ vÃ  sá»‘",correct:false}]},
  {q:"NÃªn thay Ä‘á»•i máº­t kháº©u ___ Ä‘á»ƒ trÃ¡nh bá»‹ hack.",answers:[
    {text:"khÃ´ng bao giá»",correct:false},
    {text:"thÆ°á»ng xuyÃªn",correct:true},
    {text:"chá»‰ khi bá»‹ quÃªn",correct:false}]},
  {q:"KhÃ´ng nÃªn sá»­ dá»¥ng ___ giá»‘ng nhau cho nhiá»u tÃ i khoáº£n.",answers:[
    {text:"máº­t kháº©u",correct:true},
    {text:"email",correct:false},
    {text:"tÃªn Ä‘Äƒng nháº­p",correct:false}]}];

let adviceIndex=0;
function showAdviceGame(){ adviceIndex=0; showAdviceQuestion(); }
function showAdviceQuestion(){
  if(adviceIndex>=adviceQuestions.length){ advicePopup.style.display='none'; showOutro(); return; }
  const q=adviceQuestions[adviceIndex];
  adviceQuestionEl.textContent=q.q;
  adviceAnswersDiv.innerHTML="";
  q.answers.forEach(ans=>{
    const btn=document.createElement('button');
    btn.textContent=ans.text;
    btn.onclick=()=>{
      if(ans.correct){ correctSound.currentTime=0; correctSound.play(); alert("Chá»n Ä‘Ãºng! ğŸ‰"); adviceIndex++; }
      else{ wrongSound.currentTime=0; wrongSound.play(); alert("Sai, thá»­ láº¡i ğŸ˜¢"); }
      showAdviceQuestion();
    };
    adviceAnswersDiv.appendChild(btn);
  });
  advicePopup.style.display='block';
  
  }
  function startActivity3(){
  // áº¨n cÃ¡c mÃ n hÃ¬nh khÃ¡c
  gameArea.style.display='none';
  quizPopup.style.display='none';
  congratsPopup.style.display='none';
  videoPopup.style.display='none';
  outroScreen.style.display='none';
  
  // Hiá»ƒn thá»‹ mÃ n hÃ¬nh Hoáº¡t Ä‘á»™ng 3
  document.getElementById('activity3Screen').style.display='flex';
  
  // NÃºt tiáº¿p tá»¥c Ä‘á»ƒ qua outro
  document.getElementById('activity3NextBtn').onclick = () => {
    document.getElementById('activity3Screen').style.display='none';
    // Gá»i outro gá»‘c
    if(typeof originalShowOutro === 'function') originalShowOutro();
    else document.getElementById('outroScreen').style.display='flex';
  };
}

// Sá»­a finishQuizFlow Ä‘á»ƒ gá»i startActivity3 trÆ°á»›c outro
function finishQuizFlow(){
  quizPopup.style.display = 'none';
  congratsPopup.style.display = 'none';
  videoPopup.style.display = 'none';
  
  // Gá»i Hoáº¡t Ä‘á»™ng 3 trÆ°á»›c outro
  startActivity3();
}

// --- OUTRO ---
function showOutro(){
    window.endTime = Date.now();
    window.totalTime = Math.floor((window.endTime - window.startTime)/1000);
    if(window.correctAnswers!==undefined){ window.playerScore = window.correctAnswers - window.totalTime; }
 document.getElementById("top50Btn").style.display="block";
 const score=computeScore(window.correctAnswers||0, window.totalTime||0); window.playerScore=score;
  // rename button
  document.getElementById("towerGuideBtn").innerText = "Báº£ng xáº¿p háº¡ng";

  setTimeout(()=>{ 
    if(document.getElementById('leaderboard')) {
      document.getElementById('leaderboard').style.display='block';
      if(window.loadLeaderboard) loadLeaderboard();
    }
  }, 2500);  // show after outro animation

  advicePopup.style.display='none';
  gameArea.style.display='none';
  gameTitle.style.display='none';
  towerGuide.style.display='none';
  outroScreen.style.display='flex';
  setTimeout(()=>document.getElementById('outroTitle').style.opacity=1,100);
  setTimeout(()=>document.getElementById('outroText').style.opacity=1,1100);
  setTimeout(()=>outroChar.style.opacity=1,2100);
}

// --- HÆ¯á»šNG DáºªN THÃP ---
function openTowerGuide(){
  document.getElementById('towerGuidePopup').style.display='flex';
}

function closeTowerGuide(){ document.body.classList.add('hide-big-qr');
  document.getElementById('towerGuidePopup').style.display='none';
  typeIntro();  // << Báº®T Äáº¦U INTRO SAU KHI áº¤N ÄÃ“NG
 document.getElementById('smallQR').style.display='block';}

// Hide poster when story shown
document.getElementById('storyOverlay').addEventListener('transitionstart',()=>{
  try{ document.getElementById('poster').style.display='none'; }catch(e){}
});


function showTop50(){
 document.getElementById("leaderboard").style.display="block";
 if(window.loadLeaderboard) loadLeaderboard();
}

function computeScore(correct, time){
 return correct*100 - time;
}

</script>
<!-- ======= APPENDED SCRIPT: chÃºc má»«ng â†’ video â†’ quiz (KHÃ”NG Sá»¬A GAME) ======= -->
<script>
/*
  LÆ¯U Ã: Ä‘oáº¡n nÃ y chá»‰ "thÃªm" chá»©c nÄƒng má»›i.
  - Khi hÃ m showOutro() Ä‘Æ°á»£c gá»i, nÃ³ sáº½ hiá»ƒn thá»‹ popup chÃºc má»«ng (mÃ¬nh ghi Ä‘Ã¨ hÃ m runtime).
  - Sau khi hoÃ n táº¥t quiz, hÃ m showOutro gá»‘c sáº½ Ä‘Æ°á»£c gá»i Ä‘á»ƒ hiá»ƒn thá»‹ outro ban Ä‘áº§u.
*/

// LÆ°u hÃ m showOutro gá»‘c
const originalShowOutro = window.showOutro;

// Náº¿u khÃ´ng tá»“n táº¡i hÃ m gá»‘c (trÆ°á»ng há»£p), Ä‘áº£m báº£o originalShowOutro lÃ  null
// (trong file gá»‘c, showOutro luÃ´n Ä‘Æ°á»£c Ä‘á»‹nh nghÄ©a nÃªn originalShowOutro sáº½ lÃ  function)
if (typeof originalShowOutro !== 'function') {
  // khÃ´ng cÃ³ hÃ m gá»‘c â€” define 1 hÃ m máº·c Ä‘á»‹nh an toÃ n
  window.showOutro = function(){
    document.getElementById('outroScreen').style.display='flex';
  };
} else {
  // GHI ÄÃˆ showOutro báº±ng 1 hÃ m má»›i, nhÆ°ng sáº½ gá»i originalShowOutro sau khi quiz xong
  window.showOutro = function(){
    // Hiá»‡n popup chÃºc má»«ng (má»›i)
    document.getElementById('congratsPopup').style.display = 'block';
  };
}

// DOM elements for new flow
const congratsPopup = document.getElementById('congratsPopup');
const watchVideoBtn = document.getElementById('watchVideoBtn');
const skipToQuizBtn = document.getElementById('skipToQuizBtn');
const videoPopup = document.getElementById('videoPopup');
const lessonVideo = document.getElementById('lessonVideo');
const skipVideoBtn = document.getElementById('skipVideoBtn');
const quizPopup = document.getElementById('quizPopup');
const quizBody = document.getElementById('quizBody');
const nextQuizBtn = document.getElementById('nextQuizBtn');

// Äá»‹nh nghÄ©a ná»™i dung 4 cÃ¢u há»i theo yÃªu cáº§u (má»™t sá»‘ cÃ¢u cho phÃ©p nhiá»u Ä‘Ã¡p Ã¡n)
const finalQuiz = [
  {
    id: 1,
    type: 'single',
    q: 'CÃ¢u 1: ÄÃ¢u "KHÃ”NG" pháº£i lÃ  nguyÃªn nhÃ¢n khiáº¿n Minh bá»‹ lá»«a Ä‘áº£o qua máº¡ng?',
    options: [
      'Tin tÆ°á»Ÿng vÃ o báº¡n bÃ¨',
      'Háº¥p táº¥p, thiáº¿u suy nghÄ©',
      'VÃ¬ nhÃ  Minh giÃ u'
    ],
    correctIndex: 2
  },
  {
    id: 2,
    type: 'single',
    q: 'CÃ¢u 2: Äá»‘i tÆ°á»£ng lá»«a Ä‘áº£o Ä‘Ã£ sá»­ dá»¥ng thá»§ Ä‘oáº¡n nÃ o Ä‘á»ƒ khiáº¿n nhÃ¢n váº­t tin lÃ  tháº­t?',
    options: [
      'Giáº£ máº¡o tÃ i khoáº£n báº¡n bÃ¨ vÃ  nháº¯n tin vá»›i giá»ng Ä‘iá»‡u quen thuá»™c.',
      'Tiáº¿p cáº­n náº¡n nhÃ¢n lÃ m quen vÃ  dáº§n dáº§n trá»Ÿ thÃ nh báº¡n bÃ¨ Ä‘á»ƒ lá»«a Ä‘áº£o.',
      'Há»‘i thÃºc nhÃ¢n váº­t thá»±c hiá»‡n nhanh Ä‘á»ƒ â€œkhÃ´ng bá» lá»¡ cÆ¡ há»™iâ€.'
    ],
    correctIndex: 1 // Ä‘Ã¡p Ã¡n báº¡n yÃªu cáº§u
  },
  {
    id: 3,
    type: 'single',
    q: 'CÃ¢u 3: Sau khi bá»‹ lá»«a Ä‘áº£o, nhÃ¢n váº­t Ä‘Ã£ gáº·p pháº£i háº­u quáº£ gÃ¬?',
    options: [
      'Máº¥t tiá»n.',
      'Lá»™ thÃ´ng tin cÃ¡ nhÃ¢n / tÃ i khoáº£n bá»‹ chiáº¿m quyá»n.',
      'Bá»‹ Ä‘e dá»a hoáº·c tiáº¿p tá»¥c bá»‹ nháº¯n tin lá»«a Ä‘áº£o.',
      'Táº¥t cáº£ cÃ¡c háº­u quáº£ trÃªn.'
    ],
    correctIndex: 3
  },
  {
    id: 4,
    type: 'single',
    q: 'CÃ¢u 4: ThÃ´ng Ä‘iá»‡p cá»§a Ä‘oáº¡n video trÃªn lÃ  gÃ¬?',
    options: [
      'KhÃ´ng nÃªn tin tÆ°á»Ÿng tuyá»‡t Ä‘á»‘i vÃ o báº¥t ká»³ ai trÃªn máº¡ng, ká»ƒ cáº£ ngÆ°á»i quen.',
      'Internet luÃ´n an toÃ n nÃªn cÃ³ thá»ƒ thoáº£i mÃ¡i chia sáº» thÃ´ng tin cÃ¡ nhÃ¢n.',
      'Cáº£nh giÃ¡c vá»›i Ä‘Æ°á»ng link, quÃ  táº·ng, Æ°u Ä‘Ã£i Ä‘Æ°á»£c gá»­i Ä‘á»™t ngá»™t.'
    ],
    // Báº¡n nÃ³i Ä‘Ã¡p Ã¡n 0 khÃ´ng Ä‘Ãºng â†’ báº¡n cho tá»› biáº¿t Ä‘Ã¡p Ã¡n Ä‘Ãºng Ä‘á»ƒ tá»› Ä‘iá»n vÃ o!
    correctIndex: 0
  }
];

let quizIndex = 0;

// HÃ m hiá»ƒn thá»‹ cÃ¢u há»i quiz hiá»‡n táº¡i
function renderQuizQuestion(){
  const item = finalQuiz[quizIndex];
  quizBody.innerHTML = '';
  const title = document.createElement('div');
  title.style.fontWeight = '700';
  title.style.marginBottom = '8px';
  title.textContent = item.q;
  quizBody.appendChild(title);

  if(item.type === 'single'){
    const wrap = document.createElement('div');
    wrap.className = 'quiz-answers';
    item.options.forEach((opt, i) => {
      const btn = document.createElement('button');
      btn.textContent = opt;
      btn.onclick = () => {
        // kiá»ƒm tra
        if(i === item.correctIndex){
          correctSound.currentTime = 0; correctSound.play();
          alert('ChÃ­nh xÃ¡c! ğŸ‰');
          quizIndex++;
          if(quizIndex >= finalQuiz.length){
            finishQuizFlow();
          } else {
            renderQuizQuestion();
          }
        } else {
          wrongSound.currentTime = 0; wrongSound.play();
          alert('Sai rá»“i, thá»­ láº¡i nhÃ© ğŸ˜¢');
        }
      };
      wrap.appendChild(btn);
    });
    quizBody.appendChild(wrap);
    // nÃºt next áº©n vá»›i cÃ¢u single (báº¥m Ä‘Ã¡p Ã¡n sáº½ tá»± chuyá»ƒn)
    nextQuizBtn.style.display = 'none';
  } else if(item.type === 'multi'){
    // hiá»ƒn thá»‹ checkbox + nÃºt submit
    const box = document.createElement('div');
    box.className = 'checkbox-row';
    item.options.forEach((opt, i) => {
      const label = document.createElement('label');
      const cb = document.createElement('input');
      cb.type = 'checkbox';
      cb.dataset.idx = i;
      cb.style.marginRight = '8px';
      label.appendChild(cb);
      const span = document.createElement('span');
      span.textContent = opt;
      label.appendChild(span);
      box.appendChild(label);
    });
    quizBody.appendChild(box);

    // show submit button
    nextQuizBtn.style.display = 'inline-block';
    nextQuizBtn.textContent = 'Ná»™p Ä‘Ã¡p Ã¡n';
    // Ä‘áº£m báº£o listener khÃ´ng bá»‹ Ä‘Äƒng kÃ½ nhiá»u láº§n
    nextQuizBtn.onclick = () => {
      const checked = Array.from(box.querySelectorAll('input[type="checkbox"]:checked')).map(n=>parseInt(n.dataset.idx));
      // sort for comparison
      checked.sort((a,b)=>a-b);
      const correct = item.correctIndexes.slice().sort((a,b)=>a-b);
      // compare arrays
      if(checked.length === correct.length && checked.every((v,i)=>v === correct[i])){
        correctSound.currentTime = 0; correctSound.play();
        alert('ChÃ­nh xÃ¡c! ğŸ‰');
        quizIndex++;
        if(quizIndex >= finalQuiz.length){
          finishQuizFlow();
        } else {
          renderQuizQuestion();
        }
      } else {
        wrongSound.currentTime = 0; wrongSound.play();
        alert('ChÆ°a chÃ­nh xÃ¡c. HÃ£y kiá»ƒm tra láº¡i vÃ  thá»­ láº¡i nhÃ© ğŸ˜¢');
      }
    };
  }
}

// HoÃ n táº¥t quiz â†’ gá»i outro gá»‘c Ä‘á»ƒ hiá»ƒn thá»‹ mÃ n outro cÅ©
function startActivity3(){
  // áº¨n cÃ¡c mÃ n hÃ¬nh khÃ¡c
  gameArea.style.display='none';
  quizPopup.style.display='none';
  congratsPopup.style.display='none';
  videoPopup.style.display='none';
  outroScreen.style.display='none';
  
  // Hiá»ƒn thá»‹ mÃ n hÃ¬nh Hoáº¡t Ä‘á»™ng 3
  document.getElementById('activity3Screen').style.display='flex';
  
  // NÃºt tiáº¿p tá»¥c Ä‘á»ƒ qua outro
  document.getElementById('activity3NextBtn').onclick = () => {
    document.getElementById('activity3Screen').style.display='none';
    // Gá»i outro gá»‘c
    if(typeof originalShowOutro === 'function') originalShowOutro();
    else document.getElementById('outroScreen').style.display='flex';
  };
}

// Sá»­a finishQuizFlow Ä‘á»ƒ gá»i startActivity3 trÆ°á»›c outro
function finishQuizFlow(){
  quizPopup.style.display = 'none';
  congratsPopup.style.display = 'none';
  videoPopup.style.display = 'none';
  
  // Gá»i Hoáº¡t Ä‘á»™ng 3 trÆ°á»›c outro
  startActivity3();
}


const quizData = [
  { question: "Báº¡n nÃªn lÃ m gÃ¬ Ä‘á»ƒ báº£o vá»‡ máº­t kháº©u tÃ i khoáº£n cá»§a mÃ¬nh?", options: ["DÃ¹ng ngÃ y sinh", "Táº¡o máº­t kháº©u máº¡nh vÃ  khÃ´ng chia sáº»", "Viáº¿t ra giáº¥y", "DÃ¹ng 1 máº­t kháº©u cho táº¥t cáº£"], answer: 1 },
  { question: "Khi sá»­ dá»¥ng ná»n táº£ng trá»±c tuyáº¿n, báº¡n nÃªn lÃ m gÃ¬ Ä‘á»ƒ báº£o vá»‡ quyá»n riÃªng tÆ°?", options: ["KhÃ´ng Ä‘á»c chÃ­nh sÃ¡ch", "Chia sáº» thÃ´ng tin cÃ¡ nhÃ¢n", "Kiá»ƒm tra chÃ­nh sÃ¡ch vÃ  Ä‘iá»u chá»‰nh cÃ i Ä‘áº·t", "Chá»‰ Ä‘Äƒng thÃ´ng tin cÃ´ng ty"], answer: 2 },
  { question: "Khi nháº­n Ä‘Æ°á»£c Ä‘Æ°á»ng link láº¡, báº¡n nÃªn lÃ m gÃ¬?", options: ["Nháº¥n ngay", "Chia sáº» cho báº¡n bÃ¨", "KhÃ´ng nháº¥p vÃ  kiá»ƒm tra nguá»“n gá»­i", "Sao chÃ©p vÃ o MXH há»i Ã½ kiáº¿n"], answer: 2 },
  { question: "TrÆ°á»›c khi Ä‘Äƒng báº¥t cá»© ná»™i dung nÃ o lÃªn máº¡ng, báº¡n cáº§n chÃº Ã½ Ä‘iá»u gÃ¬?", options: ["Ná»™i dung hÃ i hÆ°á»›c", "Ná»™i dung an toÃ n, phÃ¹ há»£p, khÃ´ng gÃ¢y háº¡i", "CÃ³ nhiá»u lÆ°á»£t like", "TrÃ¹ng bÃ i ngÆ°á»i khÃ¡c"], answer: 1 }
];

let current = 0;

function showQuestion() {
  if(current >= quizData.length){
    document.getElementById("quiz").style.display = "none";
    document.getElementById("poster").style.display = "block"; // hiá»‡n poster
    return;
  }

  const q = quizData[current];
  document.getElementById("question").innerText = q.question;
  const optionsDiv = document.getElementById("options");
  optionsDiv.innerHTML = "";

  q.options.forEach((opt, i) => {
    const btn = document.createElement("button");
    btn.innerText = opt;
    btn.style.padding = "10px 16px";
    btn.style.borderRadius = "8px";
    btn.style.border = "none";
    btn.style.cursor = "pointer";
    btn.style.background = "#00a8ff";
    btn.style.color = "#fff";
    btn.style.fontWeight = "600";
    btn.style.margin = "5px";
    btn.onclick = () => checkAnswer(i);
    optionsDiv.appendChild(btn);
  });
}

function checkAnswer(selected){
  if(selected === quizData[current].answer){

    // ğŸ”ŠÃ‚m thanh Ä‘Ãºng
    correctSound.currentTime = 0;
    correctSound.play();
    alert("ÄÃºng rá»“i");
    current++;
    showQuestion();

  } else {

    // ğŸ”ŠÃ‚m thanh sai
    wrongSound.currentTime = 0;
    wrongSound.play();

    alert("Sai rá»“i, thá»­ láº¡i nhÃ©!");
  }
}

// Khi báº¯t Ä‘áº§u hoáº¡t Ä‘á»™ng 3
function startActivity3(){
  document.getElementById('activity3Screen').style.display='flex';
  current = 0;
  document.getElementById("quiz").style.display = "flex";
  document.getElementById("poster").style.display = "none";
  showQuestion();
}

// Báº¯t Ä‘áº§u quiz
showQuestion();

// Sá»± kiá»‡n cho nÃºt trÃªn popup chÃºc má»«ng
watchVideoBtn.onclick = () => {
  congratsPopup.style.display = 'none';
  // show video popup
  videoPopup.style.display = 'block';
  // reset video to start
  try { lessonVideo.currentTime = 0; } catch(e){}
  lessonVideo.play().catch(()=>{});
};

skipToQuizBtn.onclick = () => {
  congratsPopup.style.display = 'none';
  // Báº¯t Ä‘áº§u quiz trá»±c tiáº¿p
  quizIndex = 0;
  quizPopup.style.display = 'block';
  renderQuizQuestion();
};

// Sá»± kiá»‡n cho nÃºt bá» qua video
skipVideoBtn.onclick = () => {
  try { lessonVideo.pause(); } catch(e){}
  videoPopup.style.display = 'none';
  quizIndex = 0;
  quizPopup.style.display = 'block';
  renderQuizQuestion();
};

// Khi video káº¿t thÃºc â†’ báº¯t Ä‘áº§u quiz
lessonVideo.onended = () => {
  videoPopup.style.display = 'none';
  quizIndex = 0;
  quizPopup.style.display = 'block';
  renderQuizQuestion();
};

// ÄÃ³ng táº¥t cáº£ popup khi nháº¥n ra ngoÃ i (tuá»³ chá»n) â€” khÃ´ng báº¯t buá»™c
// (KhÃ´ng gáº¯n sá»± kiá»‡n Ä‘Ã³ng khi báº¥m ngoÃ i Ä‘á»ƒ trÃ¡nh vÃ´ tÃ¬nh Ä‘Ã³ng)

// === Táº M Dá»ªNG NHáº C Ná»€N KHI XEM VIDEO ===
(function(){
  try {
    const bgMusicEl = document.getElementById('bgMusic');
    const lessonVideoEl = document.getElementById('lessonVideo');
    const skipVideoBtnEl = document.getElementById('skipVideoBtn');

    if(!bgMusicEl || !lessonVideoEl || !skipVideoBtnEl) return;

    // Khi video báº¯t Ä‘áº§u phÃ¡t â†’ táº¡m dá»«ng nháº¡c ná»n
    lessonVideoEl.addEventListener('play', () => {
      try { bgMusicEl.pause(); } catch(e){}
    });

    // Khi video káº¿t thÃºc â†’ tiáº¿p tá»¥c nháº¡c ná»n
    lessonVideoEl.addEventListener('ended', () => {
      try { bgMusicEl.play().catch(()=>{}); } catch(e){}
    });

    // Khi ngÆ°á»i báº¥m "Bá» qua video" â†’ tiáº¿p tá»¥c nháº¡c ná»n
    skipVideoBtnEl.addEventListener('click', () => {
      try { bgMusicEl.play().catch(()=>{}); } catch(e){}
    });

  } catch(e){}
})();
function startActivity3() {
    // áº¨n Táº¤T Cáº¢ cÃ¡c mÃ n hÃ¬nh cÅ© trÆ°á»›c khi vÃ o hoáº¡t Ä‘á»™ng 3
    gameArea.style.display = 'none';
    gameTitle.style.display = 'none';
    towerGuide.style.display = 'none';
    finalPopup.style.display = 'none';
    popup.style.display = 'none';
    advicePopup.style.display = 'none';
    congratsPopup.style.display = 'none';
    videoPopup.style.display = 'none';
    quizPopup.style.display = 'none';
    outroScreen.style.display = 'none';

    // Hiá»‡n mÃ n hÃ¬nh Hoáº¡t Ä‘á»™ng 3
    document.getElementById('activity3Screen').style.display = 'flex';

    // Reset quiz con
    current = 0;
    document.getElementById("quiz").style.display = "none";
    document.getElementById("poster").style.display = "none";
}

function endActivity3(){
  // áº¨n Hoáº¡t Ä‘á»™ng 3
  document.getElementById('activity3Screen').style.display = 'none';
  // Tiáº¿p tá»¥c outro gá»‘c
  showOutro();
}
// Gáº¯n sá»± kiá»‡n cho nÃºt OK
document.getElementById('startQuizBtn').onclick = () => {
    window.startTime = Date.now();
    // áº¨n mÃ n hÃ¬nh hoáº¡t Ä‘á»™ng 3
    document.getElementById('activity3Screen').style.display = 'none';
    // Báº¯t Ä‘áº§u quiz hoáº·c outro tiáº¿p theo
    current = 0;
    document.getElementById("quiz").style.display = "flex";
    document.getElementById("poster").style.display = "none";
    showQuestion(); // gá»i hÃ m hiá»ƒn thá»‹ cÃ¢u há»i Ä‘áº§u tiÃªn
};

function showTop50(){
 document.getElementById("leaderboard").style.display="block";
 if(window.loadLeaderboard) loadLeaderboard();
}

function computeScore(correct, time){
 return correct*100 - time;
}

</script>
<!-- BEGIN: Poster congrats + story + super-quiz (added by assistant) -->
<style>
/* Poster congrats popup */
#posterCongratsOverlay, #confirmStoryOverlay, #storyOverlay, #superQuizPopup, #superQuizEnd {
  position: fixed; inset: 0; display: none; z-index: 9999; justify-content:center; align-items:center; background: rgba(0,0,0,0.6);
}
#posterCongrats, #confirmStory, #storyBox, #superQuizBox, #superQuizEndBox {
  background: #fff; border-radius:12px; padding:18px; max-width:900px; width:90%; box-shadow: 0 12px 35px rgba(0,0,0,0.4);
}
#posterCongrats .content { display:flex; gap:16px; align-items:center; }
#posterCongrats .left { flex: 0 0 40%; }
#posterCongrats .left img{ width:100%; height:auto; border-radius:8px; }
#posterCongrats .right { flex:1; text-align:left; }
#posterCongrats h2 { margin-top:0; color:#0077c8; }
.smallBtn { padding:10px 14px; border-radius:8px; border:none; cursor:pointer; font-weight:600; background:#00a8ff; color:#fff; }
.ghostBtn { background:#00a8ff; }
.storyText { max-height:360px; overflow:auto; text-align:left; line-height:1.5; color:#073b4c; }
#superQuizBox .q { font-weight:700; margin-bottom:10px; }
#superQuizBox .options button { display:block; width:100%; margin:8px 0; padding:10px; border-radius:8px; border:none; cursor:pointer; background:#00a8ff; color:#fff; font-weight:600; }
#superQuizEndBox .animatedText { font-size:20px; line-height:1.6; text-align:center; padding:20px; }
</style>
<!-- Poster congrats overlay -->
<div aria-hidden="true" id="posterCongratsOverlay">
<div id="posterCongrats" role="dialog">
<div style="display:flex; justify-content:space-between; align-items:flex-start;">
<h2>ChÃºc má»«ng â€” Báº¡n Ä‘Ã£ hoÃ n thÃ nh poster giÃºp Lan!</h2>
<button onclick="closePosterCongrats()" style="background:transparent;border:none;font-size:20px;cursor:pointer;">âœ•</button>
</div>
<div class="content" style="margin-top:10px;">
<div class="left"><img alt="Poster" src="posternhÃ©.png"/></div>
<div class="right">
<p>Báº¡n Ä‘Ã£ hoÃ n thÃ nh poster giÃºp Lan. HÃ£y nháº¥n tiáº¿p tá»¥c Ä‘á»ƒ nghe má»™t cÃ¢u chuyá»‡n dá»±a trÃªn má»™t cÃ¢u chuyá»‡n cÃ³ tháº­t giÃºp hiá»ƒu thÃªm vá» cÃ¡ch káº» gian lá»£i dá»¥ng chá»‹ A.</p>
<div style="margin-top:12px; display:flex; gap:8px;">
<button class="smallBtn" id="pcContinueBtn">Tiáº¿p tá»¥c</button>
</div>
</div>
</div>
</div>
</div>
<!-- Confirm to view story -->
<div aria-hidden="true" id="confirmStoryOverlay">
<div id="confirmStory">
<h2> Báº¡n cÃ³ muá»‘n nghe chuyá»‡n cá»§a chá»‹ A (dá»±a trÃªn cÃ¢u chuyá»‡n cÃ³ tháº­t)?</h2>
<p style="color:#333;">Nghe cÃ¢u chuyá»‡n sáº½ giÃºp báº¡n hiá»ƒu rÃµ cÃ¡ch lá»«a Ä‘áº£o váº­n hÃ nh. Báº¡n cÃ³ thá»ƒ <strong>Bá» qua</strong> vÃ  tráº£ lá»i cÃ¢u há»i ngay.</p>
<div style="display:flex; gap:10px; margin-top:12px;">
<button class="smallBtn" id="agreeStoryBtn">Äá»“ng Ã½ â€” Nghe chuyá»‡n</button>
</div>
</div>
</div>
<!-- Story overlay -->
<div aria-hidden="true" id="storyOverlay">
<div id="storyBox">
<h2>Chuyá»‡n cá»§a chá»‹ A</h2>
<div class="storyText" id="storyText">
<p>Má»™t sinh viÃªn nÄƒm nháº¥t lÃ m thÃªm táº¡i má»™t cá»­a hÃ ng nhá». Má»™t buá»•i chiá»u, báº¡n nháº­n Ä‘Æ°á»£c cuá»™c gá»i tá»« má»™t ngÆ°á»i tá»± xÆ°ng lÃ  shipper. Anh ta nÃ³i ráº±ng Ä‘ang giá»¯ má»™t mÃ³n hÃ ng gá»­i cho báº¡n, nhÆ°ng sinh viÃªn nÃ y kháº³ng Ä‘á»‹nh mÃ¬nh khÃ´ng há» Ä‘áº·t hÃ ng. Ban Ä‘áº§u, báº¡n ráº¥t tá»‰nh tÃ¡o vÃ  tráº£ lá»i rÃµ rÃ ng:.</p>
<p>Báº¡n Ä‘á»c tiáº¿p dÆ°á»›i...</p>
<p>â€œTÃ´i khÃ´ng Ä‘áº·t gÃ¬ cáº£, anh giao nháº§m rá»“i.â€

Shipper váº«n khÄƒng khÄƒng ráº±ng Ä‘Ã¢y lÃ  hÃ ng â€œÄ‘áº·t trÆ°á»›câ€, yÃªu cáº§u báº¡n pháº£i ra nháº­n Ä‘á»ƒ kiá»ƒm tra. Sinh viÃªn nÄƒm nháº¥t nÃ y tá»« chá»‘i thÃªm vÃ i láº§n nhÆ°ng anh ta liÃªn tá»¥c gá»i láº¡i, giá»ng ngÃ y cÃ ng gáº¥p gÃ¡p vÃ  khÃ³ chá»‹u.
DÃ¹ váº­y, báº¡n váº«n ráº¥t tá»‰nh tÃ¡o vÃ  tin cháº¯c ráº±ng Ä‘Ã¢y lÃ  lá»«a Ä‘áº£o nÃªn Ä‘Ã£ cÃºp mÃ¡y.

Má»™t tuáº§n sau

CÃ³ má»™t sá»‘ láº¡ gá»i Ä‘áº¿n. NgÆ°á»i Ä‘Ã n Ã´ng tá»± xÆ°ng lÃ  cÃ´ng an, giá»ng nghiÃªm nghá»‹:

â€œEm cÃ³ biáº¿t lÃ  sá»‘ Ä‘iá»‡n thoáº¡i cá»§a anh shipper nÃ y Ä‘Ã£ tá»«ng gá»i Ä‘áº¿n em nhiá»u láº§n khÃ´ng,vÃ  anh ta Ä‘Ã£ bÃ¡o cho chÃºng tÃ´i,cÃ³ liÃªn quan tá»›i gÃ³i hÃ ng cá»§a chá»‹.GÃ³i Ä‘Ã³ cÃ³ chá»©a cháº¥t cáº¥m,yÃªu cáº§u chá»‹ Ä‘áº¿n cÆ¡ quan chÃºng tÃ´i lÃ m viá»‡c gáº¥p.â€</p>
<p>Ngay láº­p tá»©c, sinh viÃªn nÄƒm nháº¥t nháº­n ra:
ÄÃ³ chÃ­nh lÃ  sá»‘ Ä‘iá»‡n thoáº¡i Ä‘Ã£ gá»i mÃ¬nh tuáº§n trÆ°á»›c.

Nghe Ä‘áº¿n chá»¯ â€œhÃ ng cáº¥mâ€, báº¡n báº¯t Ä‘áº§u bá»‘i rá»‘i.
Trong Ä‘áº§u chá»‰ cÃ²n má»™t suy nghÄ©:

Náº¿u tháº­t lÃ  hÃ ng cáº¥m thÃ¬ sao? MÃ¬nh khÃ´ng nháº­n thÃ¬ cÃ³ bá»‹ nghi oan khÃ´ng?

CÃ ng hoang mang, báº¡n cÃ ng bá»‹ dáº«n dáº¯t.

NgÆ°á»i tá»± xÆ°ng cÃ´ng an nÃ³i thÃªm, giá»ng hÃ¹ dá»a:

â€œNáº¿u em khÃ´ng há»£p tÃ¡c, chÃºng tÃ´i buá»™c pháº£i Ä‘Æ°a em vÃ o diá»‡n nghi váº¥n.â€

Rá»“i Ã´ng ta báº£o sáº½ â€œchuyá»ƒn mÃ¡y cho cÃ¡n bá»™ há»— trá»£â€ Ä‘á»ƒ lÃ m thá»§ tá»¥c xÃ¡c minh.â€</p>
<p>VÃ i giÃ¢y sau, má»™t ngÆ°á»i khÃ¡c nÃ³i chuyá»‡n â€“ thá»±c cháº¥t váº«n lÃ  káº» lá»«a Ä‘áº£o nhÆ°ng Ä‘á»•i vai:

â€œNáº¿u em khÃ´ng tá»›i Ä‘Æ°á»£c mÃ  cÅ©ng khÃ´ng muá»‘n bá»‹ pháº¡t, tÃ´i sáº½ hÆ°á»›ng dáº«n em xÃ¡c minh nhanh. Em chá»‰ cáº§n Ä‘Ã³ng phÃ­ kiá»ƒm tra há»‡ thá»‘ng Ä‘á»ƒ xÃ³a tÃªn khá»i há»“ sÆ¡.â€

Cáº£m giÃ¡c hoang mang ngÃ y cÃ ng lá»›n.
Sinh viÃªn má»Ÿ tÃ i khoáº£n Ä‘á»ƒ chuyá»ƒn phÃ­ nhÆ°ng tiá»n trong tháº» khÃ´ng Ä‘á»§.

Láº­p tá»©c, háº¯n dá»¥ tiáº¿p:

â€œKhÃ´ng sao. Em vay táº¡m ngÃ¢n hÃ ng online Ä‘i cho nhanh. TÃ´i gá»­i link nÃ¨, chá»‰ cáº§n báº¥m lÃ  vay Ä‘Æ°á»£c 25 triá»‡u. Xá»­ lÃ½ 5 phÃºt.â€

Cáº¡m báº«y cuá»‘i

Trong cÆ¡n sá»£ hÃ£i, sinh viÃªn nÄƒm nháº¥t áº¥n vÃ o link.
Trang web hiá»‡n lÃªn giá»‘ng há»‡t ngÃ¢n hÃ ng tháº­t, cÃ³ logo, sá»‘ há»£p Ä‘á»“ng, chá»¯ kÃ½ Ä‘iá»‡n tá»­.

KhÃ´ng ká»‹p suy nghÄ©, báº¡n nháº­p toÃ n bá»™ thÃ´ng tin cÃ¡ nhÃ¢n, rá»“i chuáº©n bá»‹ báº¥m â€œXÃ¡c nháº­n vayâ€.

ÄÃºng lÃºc Ä‘Ã³, Ä‘á»“ng nghiá»‡p trong cá»­a hÃ ng Ä‘i ngang tháº¥y máº·t báº¡n tÃ¡i mÃ©t, tay run run nÃªn há»i:

â€œEm lÃ m gÃ¬ mÃ  cÄƒng tháº³ng váº­y?â€.</p>
<p>Nghe báº¡n ká»ƒ vÃ i cÃ¢u, cÃ´ Ä‘á»“ng nghiá»‡p láº­p tá»©c hiá»ƒu Ä‘Ã¢y lÃ  mÃ n giáº£ danh cÃ´ng an â€“ lá»«a Ä‘áº£o tÃ i chÃ­nh.
CÃ´ giáº­t láº¡i Ä‘iá»‡n thoáº¡i, táº¯t trang web giáº£ vÃ  yÃªu cáº§u báº¡n Ä‘á»«ng chuyá»ƒn báº¥t ká»³ Ä‘á»“ng nÃ o.

NhÆ°ng Ä‘Ã£ quÃ¡ muá»™n má»™t pháº§n:
Sinh viÃªn nÄƒm nháº¥t Ä‘Ã£ vay tiá»n tháº­t tá»« má»™t app cho vay vá»›i lÃ£i suáº¥t cá»±c cao â€“ 25 triá»‡u.

Chá»‰ cÃ²n thiáº¿u má»™t cÃº báº¥m ná»¯a thÃ´i, báº¡n Ä‘Ã£:

Chuyá»ƒn toÃ n bá»™ sá»‘ tiá»n Ä‘Ã³ cho káº» lá»«a Ä‘áº£o.

ThoÃ¡t náº¡n â€“ nhÆ°ng váº«n pháº£i tráº£ giÃ¡

Nhá» sá»± can thiá»‡p ká»‹p thá»i, sinh viÃªn nÄƒm nháº¥t may máº¯n khÃ´ng máº¥t tiá»n cho bá»n lá»«a Ä‘áº£o.
NhÆ°ng báº¡n pháº£i gÃ¡nh khoáº£n ná»£ lÃ£i khá»•ng lá»“ tá»« app vay tiá»n.</p>
<p>Sau sá»± viá»‡c, sinh viÃªn run ráº©y nÃ³i:

â€œLÃºc Ä‘áº§u em tá»‰nh tÃ¡o láº¯mâ€¦ nhÆ°ng há» nÃ³i hÃ ng cáº¥m, rá»“i cÃ²n giáº£ danh cÃ´ng anâ€¦ lÃ m em sá»£ quÃ¡, máº¥t háº¿t lÃ½ trÃ­.â€</p>
</div>
<audio controls="" id="storyAudio" style="width:100%; margin-top:12px;">
<source src="voice1.mp3" type="audio/mpeg"/>
      TrÃ¬nh duyá»‡t khÃ´ng há»— trá»£ audio.
    </audio>
<div style="display:flex; gap:10px; margin-top:12px;">
<button class="smallBtn ghostBtn" id="storySkipBtn">ÄÃ£ nghe xong â€” Qua cÃ¢u há»i</button>
</div>
</div>
</div>
<!-- Super quiz popup -->
<div aria-hidden="true" id="superQuizPopup">
<div id="superQuizBox">
<h2>ğŸ§ ğŸ”¥ 5 CÃ¢u tráº¯c nghiá»‡m khÃ³</h2>
<div id="superQuizContent">
<!-- question/content injected by JS -->
</div>
</div>
</div>
<!-- Super quiz end popup with animated text (will play mp3) -->
<div aria-hidden="true" id="superQuizEnd">
<div id="superQuizEndBox">
<h2>Káº¿t thÃºc bÃ i kiá»ƒm tra</h2>
<div class="animatedText" id="animatedText">Cáº£m Æ¡n báº¡n Ä‘Ã£ hoÃ n thÃ nh! HÃ£y luÃ´n cáº£nh giÃ¡c vÃ  chia sáº» kiáº¿n thá»©c nÃ y vá»›i ngÆ°á»i thÃ¢n.</div>
<audio id="endAudio" style="display:none;">
<source src="voice1.mp3" type="audio/mpeg"/>
</audio>
<div style="display:flex; justify-content:center; margin-top:12px;">
<button class="smallBtn" onclick="closeSuperQuizEnd()">ÄÃ³ng</button>
</div>
</div>
</div>
<script>
// --- Wire up interception of Hoáº¡t Ä‘á»™ng 3 final question ---
// Keep reference to original checkAnswer if exists
const originalCheckAnswer = window.checkAnswer || null;

// Super-quiz data (using the 4 questions provided in the user's text)
const superQuiz = [
 {
    q: "1. Nháº­n diá»‡n Ä‘iá»ƒm Ä‘á»™t phÃ¡ tÃ¢m lÃ½: Trong toÃ n bá»™ ká»‹ch báº£n, thá»i Ä‘iá»ƒm chÃ­nh xÃ¡c khiáº¿n sinh viÃªn tá»« tráº¡ng thÃ¡i tá»‰nh tÃ¡o chuyá»ƒn sang suy nghÄ© lá»‡ch láº¡c nháº¥t lÃ  lÃºc nÃ o?",
    options: [
      "A. Khi shipper liÃªn tá»¥c gá»i vÃ  Ä‘á»•i giá»ng khÃ³ chá»‹u",
      "B. Khi nghe cÃ´ng an nÃ³i 'gÃ³i Ä‘Ã³ chá»©a cháº¥t cáº¥m'",
      "C. Khi Ä‘Æ°á»£c yÃªu cáº§u ra nháº­n hÃ ng láº§n Ä‘áº§u",
      "D. Khi tháº¥y sá»‘ Ä‘iá»‡n thoáº¡i cÃ´ng an trÃ¹ng vá»›i shipper"
    ],
    correct: 1 // B
},
{
    q: "2. Suy luáº­n vá» cáº¥u trÃºc tá»• chá»©c cá»§a káº» lá»«a Ä‘áº£o: Viá»‡c má»™t ngÆ°á»i Ä‘Ã³ng 3 vai (shipper â†’ cÃ´ng an â†’ cÃ¡n bá»™ há»— trá»£) cho tháº¥y Ä‘iá»u gÃ¬?",
    options: [
      "A. Há» cá»‘ tÃ¬nh dÃ¹ng nhiá»u vai Ä‘á»ƒ gÃ¢y nhiá»…u loáº¡n nháº­n thá»©c",
      "B. Há» cÃ³ cÃ´ng nghá»‡ giáº£ sá»‘ nÃªn khÃ´ng cáº§n nhiá»u ngÆ°á»i",
      "C. Há» lÃ m viá»‡c má»™t mÃ¬nh nÃªn pháº£i kiÃªm nhiá»u vai",
      "D. Há» thiáº¿u ká»‹ch báº£n nÃªn pháº£i thay Ä‘á»•i tÃ¹y Ã½"
    ],
    correct: 0 // A
},
{
    q: "3. Äiá»ƒm phi logic lá»›n nháº¥t: Trong Ä‘oáº¡n sinh viÃªn chuáº©n bá»‹ báº¥m 'XÃ¡c nháº­n vay', Ä‘Ã¢u lÃ  tÃ­n hiá»‡u phi logic rÃµ nháº¥t chá»©ng minh Ä‘Ã¢y lÃ  lá»«a Ä‘áº£o?",
    options: [
      "A. YÃªu cáº§u vay Ä‘Ãºng 25 triá»‡u thay vÃ¬ sá»‘ khÃ¡c",
      "B. Gá»­i link vay nhanh nhÆ°ng váº«n tá»± xÆ°ng 'cÃ´ng an xá»­ lÃ½ há»“ sÆ¡'",
      "C. Website cÃ³ logo y nhÆ° ngÃ¢n hÃ ng tháº­t",
      "D. Báº£o xá»­ lÃ½ chá»‰ trong 5 phÃºt"
    ],
    correct: 1 // B
},
{
    q: "4. Há»‡ quáº£ nháº­n thá»©c: LÃ½ do sÃ¢u xa khiáº¿n sinh viÃªn váº«n nháº­p toÃ n bá»™ thÃ´ng tin dÃ¹ nghi ngá» lÃ  gÃ¬?",
    options: [
      "A. VÃ¬ cáº£m giÃ¡c 'náº¿u mÃ¬nh vÃ´ tá»™i thÃ¬ cá»© há»£p tÃ¡c'",
      "B. VÃ¬ lo bá»‹ pháº¡t hÃ nh chÃ­nh lá»›n",
      "C. VÃ¬ tin á»©ng dá»¥ng vay lÃ  á»©ng dá»¥ng tháº­t",
      "D. VÃ¬ má»‡t má»i vÃ¬ bá»‹ gá»i quÃ¡ nhiá»u láº§n"
    ],
    correct: 0 // A
},
{
    q: "5. Quyáº¿t Ä‘á»‹nh pháº£n á»©ng tá»‘i Æ°u: Sau khi thoÃ¡t náº¡n má»™t pháº§n nhÆ°ng váº«n máº¯c khoáº£n ná»£ 25 triá»‡u, pháº£n á»©ng Ä‘Ãºng nháº¥t Ä‘á»ƒ giáº£m thiá»‡t háº¡i lÃ¢u dÃ i lÃ  gÃ¬?",
    options: [
      "A. Gá»i app vay Ä‘á»ƒ xin giÃ£n ná»£ vÃ  tá»± tráº£ dáº§n",
      "B. Cháº·n táº¥t cáº£ sá»‘ lá»«a Ä‘áº£o vÃ  im láº·ng",
      "C. Láº­p biÃªn báº£n trÃ¬nh bÃ¡o cÃ´ng an + liÃªn há»‡ app vay Ä‘á»ƒ bÃ¡o vá»¥ lá»«a Ä‘áº£o vÃ  yÃªu cáº§u há»— trá»£ xá»­ lÃ½",
      "D. Tráº£ ngay toÃ n bá»™ 25 triá»‡u Ä‘á»ƒ cáº¯t stress"
    ],
    correct: 2 // C
}
];

let superIndex = 0;

function renderSuperQuestion(){
  const box = document.getElementById('superQuizContent');
  box.innerHTML = '';
  if(superIndex >= superQuiz.length){
    // finished
    document.getElementById('superQuizPopup').style.display = 'none';
    showSuperQuizEnd();
    return;
  }
  const item = superQuiz[superIndex];
  const qEl = document.createElement('div');
  qEl.className = 'q';
  qEl.textContent = item.q;
  box.appendChild(qEl);
  const opts = document.createElement('div');
  opts.className = 'options';
  item.options.forEach((opt, i) => {
    const btn = document.createElement('button');
    btn.textContent = opt;
    btn.onclick = () => {
      if(i === item.correct){
        try { document.getElementById('correctSound').currentTime = 0; document.getElementById('correctSound').play(); } catch(e){}
        alert('ChÃ­nh xÃ¡c!');
        superIndex++;
        renderSuperQuestion();
      } else {
        try { document.getElementById('wrongSound').currentTime = 0; document.getElementById('wrongSound').play(); } catch(e){}
        alert('Sai rá»“i, thá»­ láº¡i nhÃ©.');
      }
    };
    opts.appendChild(btn);
  });
  box.appendChild(opts);
}

function showSuperQuiz(){
  superIndex = 0;
  document.getElementById('superQuizPopup').style.display = 'flex';
  renderSuperQuestion();
}

function showSuperQuizEnd(){
  document.getElementById('superQuizEnd').style.display = 'flex';
  // play end audio and animate text (simple fade in)
  const endAudio = document.getElementById('endAudio');
  try { endAudio.currentTime = 0; endAudio.play().catch(()=>{}); } catch(e){}
  const t = document.getElementById('animatedText');
  t.style.opacity = 0;
  setTimeout(()=> t.style.transition = 'opacity 0.8s', 50);
  setTimeout(()=> t.style.opacity = 1, 150);
}

function closeSuperQuizEnd(){
  document.getElementById('superQuizEnd').style.display = 'none';
  // continue with original outro if available
  if(typeof originalShowOutro === 'function') originalShowOutro();
  else document.getElementById('outroScreen').style.display = 'flex';
}

// Show poster congrats overlay (called when user answers Q4 correctly in activity3)
function showPosterCongrats(){
  // hide activity3 quiz
  document.getElementById('quiz').style.display = 'none';
  document.getElementById('poster').style.display = 'block';
  document.getElementById('posterCongratsOverlay').style.display = 'flex';
}

// Close poster congrats
function closePosterCongrats(){
  document.getElementById('posterCongratsOverlay').style.display = 'none';
  // show poster and resume normal flow (poster already displayed)
  document.getElementById('poster').style.display = 'block';
  // Optionally show confirm directly
}

// Hook buttons
document.addEventListener('click', function(e){
  if(e.target && e.target.id === 'pcContinueBtn'){
    document.getElementById('posterCongratsOverlay').style.display = 'none';
    document.getElementById('confirmStoryOverlay').style.display = 'flex';
  }
  if(e.target && e.target.id === 'agreeStoryBtn'){
    document.getElementById('confirmStoryOverlay').style.display = 'none';
    document.getElementById('storyOverlay').style.display = 'flex';
    // autoplay audio if possible
    try { const a = document.getElementById('storyAudio'); a.currentTime = 0; a.play().catch(()=>{}); } catch(e){}
    // when audio ends, after 3s go to super quiz
    const a = document.getElementById('storyAudio');
    if(a){
      a.onended = function(){
        setTimeout(()=>{
          document.getElementById('storyOverlay').style.display = 'none';
          showSuperQuiz();
        }, 3000);
      };
    }
  }
  if(e.target && e.target.id === 'skipStoryBtn'){
    document.getElementById('confirmStoryOverlay').style.display = 'none';
    showSuperQuiz();
  }
  if(e.target && e.target.id === 'storyOkBtn'){
    // user clicked "ÄÃ£ nghe xong" button -> wait 3s then show super quiz
    try { document.getElementById('storyAudio').pause(); } catch(e){}
    document.getElementById('storyOverlay').style.display = 'none';
    setTimeout(()=> showSuperQuiz(), 3000);
  }
  if(e.target && e.target.id === 'storySkipBtn'){
    document.getElementById('storyOverlay').style.display = 'none';
    showSuperQuiz();
  }
});

// Override activity3 checkAnswer to intercept Q4 (index 3) correct answer
if(typeof window.checkAnswer === 'function'){
  const orig = window.checkAnswer.bind(window);
  window.checkAnswer = function(selected){
    try {
      // current and quizData are globals in original script
      if(typeof current !== 'undefined' && typeof quizData !== 'undefined'){
        // If this is the 4th question (index 3) and answer is correct -> show poster congrats flow
        if(current === 3 && selected === quizData[current].answer){
          // play correct sound
          try { document.getElementById('correctSound').currentTime = 0; document.getElementById('correctSound').play(); } catch(e){}
          // Show poster congrats overlay instead of normal flow
          showPosterCongrats();
          // increment current to mark question answered (so resume state consistent)
          current++;
          return;
        }
      }
    } catch(e){ console.error(e); }
    // fallback to original behavior
    return orig(selected);
  };
} else {
  // if checkAnswer not found, create a safe stub (unlikely)
  window.checkAnswer = function(selected){
    console.warn('checkAnswer not found - interaction fallback');
  };
}

function showTop50(){
 document.getElementById("leaderboard").style.display="block";
 if(window.loadLeaderboard) loadLeaderboard();
}

function computeScore(correct, time){
 return correct*100 - time;
}

</script>
<!-- END: Poster congrats + story + super-quiz -->
<script>
// === Story Highlight Sync ===
const storyTimings = [
  {start:0, end:13.5},
  {start:13.5, end:32.8},
  {start:32.8, end:70},
  {start:70, end:105},
  {start:105, end:142},
  {start:142, end:151}
];

const storyAudio = document.getElementById('storyAudio');
const storyParas = Array.from(document.querySelectorAll('#storyText p'));

function updateHighlight(){
  const t = storyAudio.currentTime;
  storyParas.forEach((p,i)=>{
    const seg = storyTimings[i];
    if(seg && t>=seg.start && t<seg.end){
      p.style.background = 'rgba(255,255,0,0.3)';
      p.style.transition = '0.3s';
    } else {
      p.style.background = 'transparent';
    }
  });
}

storyAudio.addEventListener('timeupdate', updateHighlight);

// Popup animations
document.querySelectorAll('#posterCongrats,#confirmStory,#storyBox,#superQuizBox').forEach(el=>{
  el.style.transform='scale(0.85)';
  el.style.opacity='0';
  el.style.transition='all 0.35s ease';
  const obs=new MutationObserver(()=>{
    if(getComputedStyle(el.parentElement).display!=='none'){
      requestAnimationFrame(()=>{
        el.style.transform='scale(1)';
        el.style.opacity='1';
      });
    }
  });
  obs.observe(el.parentElement,{attributes:true,attributeFilter:['style']});
});

// Darker overlays
document.querySelectorAll('#posterCongratsOverlay,#confirmStoryOverlay,#storyOverlay,#superQuizPopup,#superQuizEnd')
  .forEach(el=>el.style.background='rgba(0,0,0,0.75)');

function showTop50(){
 document.getElementById("leaderboard").style.display="block";
 if(window.loadLeaderboard) loadLeaderboard();
}

function computeScore(correct, time){
 return correct*100 - time;
}

</script>
<script>
// -- Ensure story audio uses relative path so it loads when opening file locally --
(function(){
  const audioEl = document.querySelector('#storyAudio source');
  if(audioEl && audioEl.getAttribute('src').startsWith('/mnt/data/')) {
    audioEl.setAttribute('src', 'voice1.mp3');
    // reload parent audio element if present
    const parent = document.getElementById('storyAudio');
    if(parent){ parent.load(); }
  }
})();

// -- Hide poster when overlays show, restore when all overlays hidden --
(function(){
  const posterEl = document.getElementById('poster');
  const overlays = [
    document.getElementById('posterCongratsOverlay'),
    document.getElementById('confirmStoryOverlay'),
    document.getElementById('storyOverlay'),
    document.getElementById('superQuizPopup'),
    document.getElementById('superQuizEnd')
  ].filter(Boolean);

  function anyOverlayVisible(){
    return overlays.some(o => o && getComputedStyle(o).display !== 'none');
  }

  // Observe changes to style/display of each overlay and hide/show poster accordingly
  overlays.forEach(o=>{
    if(!o) return;
    const obs = new MutationObserver(()=>{
      try{
        if(anyOverlayVisible()){
          if(posterEl) posterEl.style.display = 'none';
        } else {
          if(posterEl) posterEl.style.display = 'block';
        }
      }catch(e){}
    });
    obs.observe(o, { attributes: true, attributeFilter: ['style', 'class'] });
  });

  // Also intercept functions that show overlays via code paths (safer)
  const origShowPosterCongrats = window.showPosterCongrats;
  window.showPosterCongrats = function(){
    if(posterEl) posterEl.style.display='none';
    if(typeof origShowPosterCongrats === 'function') origShowPosterCongrats();
  };

  // When story overlay is shown through direct style changes, ensure audio plays
  const storyOverlay = document.getElementById('storyOverlay');
  const storyAudio = document.getElementById('storyAudio');
  if(storyOverlay){
    const obs2 = new MutationObserver(()=>{
      if(getComputedStyle(storyOverlay).display !== 'none'){
        try{
          if(posterEl) posterEl.style.display='none';
          // attempt to play audio
          if(storyAudio){
            storyAudio.currentTime = 0;
            const p = storyAudio.play();
            if(p && typeof p.catch === 'function'){ p.catch(()=>{}); }
          }
        }catch(e){}
      }
    });
    obs2.observe(storyOverlay, { attributes: true, attributeFilter: ['style', 'class'] });
  }

  // Buttons that close story overlay should restore poster when closed (safety)
  ['storyOkBtn','storySkipBtn','pcContinueBtn'].forEach(id=>{
    const btn = document.getElementById(id);
    if(btn){
      btn.addEventListener('click', ()=>{
        setTimeout(()=>{ if(posterEl) posterEl.style.display='block'; }, 250);
      });
    }
  });
})();

function showTop50(){
 document.getElementById("leaderboard").style.display="block";
 if(window.loadLeaderboard) loadLeaderboard();
}

function computeScore(correct, time){
 return correct*100 - time;
}

</script>
<script>
// --- Auto pause/resume background music when story popup opens/closes ---
(function(){
  const storyOverlay = document.getElementById('storyOverlay');
  const bg = document.getElementById('bgMusic');
  if(!storyOverlay || !bg) return;

  const obs = new MutationObserver(()=>{
    const visible = getComputedStyle(storyOverlay).display !== 'none';
    if(visible){
      try{ bg.pause(); }catch(e){}
    } else {
      try{ bg.play(); }catch(e){}
    }
  });
  obs.observe(storyOverlay, { attributes:true, attributeFilter:['style','class'] });
})();

function showTop50(){
 document.getElementById("leaderboard").style.display="block";
 if(window.loadLeaderboard) loadLeaderboard();
}

function computeScore(correct, time){
 return correct*100 - time;
}

</script>
<script>
// FIX 1 â€” Táº¯t hoÃ n toÃ n poster ná»n khi Ä‘ang á»Ÿ Hoáº¡t Ä‘á»™ng 3
(function(){
    const poster = document.getElementById("poster");

    const hidePosterWhenQuizRunning = () => {
        if (typeof current !== "undefined" && current < 4) {
            poster.style.display = "none";
        }
    };

    setInterval(hidePosterWhenQuizRunning, 300);
})();

// FIX 2 â€” XÃ³a hiá»‡u á»©ng sá»c Ä‘áº±ng sau popup/story
document.body.style.background = "#6bd5ff";
document.body.style.overflow = "hidden";

function showTop50(){
 document.getElementById("leaderboard").style.display="block";
 if(window.loadLeaderboard) loadLeaderboard();
}

function computeScore(correct, time){
 return correct*100 - time;
}

</script>
<script>
// FIX chuáº©n: Khi popup story/confirm/superquiz má»Ÿ â†’ áº©n poster á»Ÿ sau
(function(){
    const overlays = [
        "confirmStoryOverlay",
        "storyOverlay",
        "superQuizPopup",
        "superQuizEnd"
    ];

    function hidePosterBehind() {
        const posterImgs = document.querySelectorAll('#posterCongrats img, #poster img');
        const someOverlayOpen = overlays.some(id => {
            const el = document.getElementById(id);
            return el && getComputedStyle(el).display !== "none";
        });

        posterImgs.forEach(img => {
            img.style.visibility = someOverlayOpen ? "hidden" : "visible";
        });
    }

    setInterval(hidePosterBehind, 200);
})();

function showTop50(){
 document.getElementById("leaderboard").style.display="block";
 if(window.loadLeaderboard) loadLeaderboard();
}

function computeScore(correct, time){
 return correct*100 - time;
}

</script>
<script>
// === FIX 1: Táº®T HOÃ€N TOÃ€N Tá»° PHÃT NHáº C á» ÄOáº N CUá»I ===
document.addEventListener("DOMContentLoaded", ()=>{
    const endAudio = document.getElementById("endAudio");
    if(endAudio){
        endAudio.autoplay = false;
        endAudio.pause();
        endAudio.play = ()=>{}; 
    }
});
if(document.getElementById("storyAudio")){
    document.getElementById("storyAudio").onended = null;
}

// === FIX 2: LÃ m highlight chá»¯ vÃ ng cháº¡y mÆ°á»£t ===
(function(){
    const storyAudio = document.getElementById("storyAudio");
    const paras = Array.from(document.querySelectorAll("#storyText p"));
    const timings = window.storyTimings || [];

    function updateFast(){
        const t = storyAudio.currentTime;
        paras.forEach((p,i)=>{
            const seg = timings[i];
            if(seg && t >= seg.start && t < seg.end){
                p.style.background = "rgba(255,255,0,0.3)";
            } else {
                p.style.background = "transparent";
            }
        });
    }

    if(storyAudio){
        setInterval(updateFast, 80); 
    }
})();

// === FIX 3: ThÃªm CHÃ‚N cho cÃ¡c TÃ’A THÃP, khÃ´ng sá»­a game ===
(function(){
    const area = document.getElementById("gameArea");
    if(area){
        const towers = document.querySelectorAll(".tower");
        towers.forEach(t=>{
            const base = document.createElement("div");
            base.style.width = "100%";
            base.style.height = "20px";
            base.style.background = "rgba(0,0,0,0.25)";
            base.style.borderRadius = "0 0 12px 12px";
            base.style.marginTop = "8px";
            t.appendChild(base);
        });
    }
})();

function showTop50(){
 document.getElementById("leaderboard").style.display="block";
 if(window.loadLeaderboard) loadLeaderboard();
}

function computeScore(correct, time){
 return correct*100 - time;
}

</script>
<script>
// Disable yellow highlight in story
(function(){
    const storyAudio = document.getElementById("storyAudio");
    const paras = document.querySelectorAll("#storyText p");
    paras.forEach(p => p.style.background = "transparent");
    if (storyAudio){ storyAudio.ontimeupdate = null; }
    if (window.storyHighlightInterval){ clearInterval(window.storyHighlightInterval); }
    window.updateHighlight = function(){};
})();

function showTop50(){
 document.getElementById("leaderboard").style.display="block";
 if(window.loadLeaderboard) loadLeaderboard();
}

function computeScore(correct, time){
 return correct*100 - time;
}

</script>
<style>
body {
    background-attachment: fixed !important;
    background-position: center bottom !important;
}
</style>
<script>
// Fully disable highlight
window.updateHighlight = function(){};
document.querySelectorAll("#storyText p").forEach(p=> p.style.background = "transparent");
if (window.storyHighlightInterval) clearInterval(window.storyHighlightInterval);

function showTop50(){
 document.getElementById("leaderboard").style.display="block";
 if(window.loadLeaderboard) loadLeaderboard();
}

function computeScore(correct, time){
 return correct*100 - time;
}

</script>
<script>
// Stop story audio when skipping
document.addEventListener("DOMContentLoaded", ()=>{
  const a=document.getElementById("storyAudio");
  const ids=["skipStoryBtn","storySkipBtn"];
  ids.forEach(id=>{
    const b=document.getElementById(id);
    if(b){
      b.addEventListener("click", ()=>{
        if(a){ a.pause(); a.currentTime=0; }
      });
    }
  });
});

function showTop50(){
 document.getElementById("leaderboard").style.display="block";
 if(window.loadLeaderboard) loadLeaderboard();
}

function computeScore(correct, time){
 return correct*100 - time;
}

</script>
<style>
#storyText p {
    background: transparent !important;
}
</style>
<script>
// Hard-disable highlight
window.updateHighlight = function(){};
if (window.storyHighlightInterval) clearInterval(window.storyHighlightInterval);

// Remove any background color that may be applied later
document.addEventListener("DOMContentLoaded", ()=>{
    document.querySelectorAll("#storyText p").forEach(p=>{
        p.style.background = "transparent";
    });
});

function showTop50(){
 document.getElementById("leaderboard").style.display="block";
 if(window.loadLeaderboard) loadLeaderboard();
}

function computeScore(correct, time){
 return correct*100 - time;
}

</script>
<!-- FIREBASE LEADERBOARD -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
  import { getFirestore, collection, addDoc, getDocs, query, orderBy, limit } 
    from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBp-d-t6eQGvXTehgoPD-h9x8B1yUg2Lc",
    authDomain: "an-toan-internet.firebaseapp.com",
    projectId: "an-toan-internet",
    storageBucket: "an-toan-internet.appspot.com",
    messagingSenderId: "32947390909",
    appId: "1:32947390909:web:71ec5d85e0b0cef78d4a5f",
    measurementId: "G-X7HLNTRBZG"
};

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  window.saveResult = async function(name, cls, school, correct, time){
    await addDoc(collection(db, "leaderboard"), {
      name, cls, school, correct, time,
      created: Date.now()
    });
  };

  window.loadLeaderboard = async function(){
    const q = query(
      collection(db, "leaderboard"),
      orderBy("correct", "desc"),
      orderBy("time", "asc"),
      limit(50)
    );
    const snap = await getDocs(q);
    let html = "";
    snap.forEach(doc=>{
      const d = doc.data();
      
let medal = "";
if (html === "") medal = "ğŸ¥‡";
else if (!html.includes("ğŸ¥‡")) medal = "ğŸ¥‡";
else if (!html.includes("ğŸ¥ˆ")) medal = "ğŸ¥ˆ";
else if (!html.includes("ğŸ¥‰")) medal = "ğŸ¥‰";

html += `<tr>
  <td class='medal'>${medal}</td>

        <td>${d.name}</td>
        <td>${d.cls}</td>
        <td>${d.school}</td>
        <td>${d.correct}</td>
        <td>${d.time}s</td>
      </tr>`;
    });
    const body = document.getElementById("leaderboardBody");
    if(body) body.innerHTML = html;
  };

  window.loadMyRank = async function(){
    const q = query(
      collection(db, "leaderboard"),
      where("name", "==", window.playerInfo.name),
      where("cls", "==", window.playerInfo.cls),
      where("school", "==", window.playerInfo.school),
      orderBy("created", "desc"),
      limit(1)
    );

    const snap = await getDocs(q);
    let htmlRow = "";
    snap.forEach(doc => {
      const d = doc.data();
      htmlRow += `
        <tr>
          <td>ğŸ…</td>
          <td>${d.name}</td>
          <td>${d.cls}</td>
          <td>${d.school}</td>
          <td>${d.correct}</td>
          <td>${d.time}s</td>
        </tr>
      `;
    });

    document.getElementById("leaderboardBody").innerHTML = htmlRow;
    document.getElementById("leaderboard").style.display = "block";
  };


function showTop50(){
 document.getElementById("leaderboard").style.display="block";
 if(window.loadLeaderboard) loadLeaderboard();
}

function computeScore(correct, time){
 return correct*100 - time;
}

</script>

</body>
</html>
