<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>HÃ nh trÃ¬nh an toÃ n máº¡ng</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap');
body { margin:0; font-family:'Poppins', sans-serif; overflow:hidden; background: linear-gradient(#6bd5ff, #b9f1ff); }
/* Sá»­a lá»—i ná»n xanh cá»§a quiz */
#quiz {
    display: none;
    flex-direction: column;
    justify-content: center; 
    align-items: center;
    height: 100vh;
    width: 100vw;
    background: linear-gradient(#6bd5ff, #b9f1ff); 
}
/* Thu nhá» poster Ä‘á»ƒ khÃ´ng bá»‹ quÃ¡ to */
#poster img {
    max-width: 90%;
    max-height: 80vh;
    object-fit: contain;
}

/* INTRO */
#introContainer,#outroScreen { width:100vw; height:100vh; display:flex; flex-direction:column; justify-content:center; align-items:center; text-align:center; padding:20px; box-sizing:border-box; }
#outroScreen { display:none; flex-direction:column; justify-content:center; align-items:center; text-align:center; animation: bgFade 5s ease-in-out infinite; }

#introText { max-width:800px; color:#004760; font-size:20px; line-height:1.6; }

/* Name input */
#nameBox { display:none; margin-top:20px; text-align:center; }
#playerName { padding:10px; font-size:18px; border-radius:10px; border:2px solid #5ab4ff; }

/* HÆ°á»›ng dáº«n trÃªn thÃ¡p */
#towerGuide { text-align:center; font-size:20px; color:#004b70; margin-top:20px; display:none; }

/* GAME */
#gameTitle { display:none; text-align:center; margin-top:20px; color:#0077c8; }
.game-area { display:none; flex-direction:row; justify-content:center; align-items:flex-end; gap: 40px; margin-top: 60px; position:relative; height:400px; }
.tower { width:120px; height:150px; border-radius:20px 20px 0 0; display:flex; flex-direction:column; align-items:center; justify-content:flex-end; cursor:pointer; position:relative; box-shadow:0 8px 20px rgba(0,0,0,0.25); transition:0.3s; }
.tower:hover { transform: scale(1.05); }
.roof { width:120px; height:40px; clip-path: polygon(50% 0%, 100% 100%, 0% 100%); margin-bottom:0; box-shadow:0 4px 10px rgba(0,0,0,0.3); }

#tower1 { background:#ffe5b4; } #tower1 .roof { background:#ff7f50; }
#tower2 { background:#d0f0c0; } #tower2 .roof { background:#32cd32; }
#tower3 { background:#c0d6f0; } #tower3 .roof { background:#1e90ff; }
#tower4 { background:#f4c2c2; } #tower4 .roof { background:#ff4500; }

.character { width:50px; height:50px; background:#ffeb3b; border-radius:50%; position:absolute; display:flex; align-items:center; justify-content:center; font-size:24px; z-index:5; transition:0.3s; }

/* POPUP */
.popup { position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:white; padding:20px; border-radius:15px; box-shadow:0 8px 25px rgba(0,0,0,0.35); display:none; z-index:10; width:350px; max-width:90vw; }
.popup h2 { margin-top:0; color:#0077c8; }
.popup button { width:100%; padding:12px; background:#00a8ff; color:white; border:none; border-radius:8px; font-weight:bold; cursor:pointer; margin-top:5px; }
.popup button:hover { background:#0077c8; }

.tower.level1 { box-shadow:0 0 10px 3px gold; height:200px; }
.tower.level2 { box-shadow:0 0 15px 5px orange; height:250px; }
.tower.level3 { box-shadow:0 0 25px 8px red; height:300px; }

/* small styles for video/quiz popups */
#congratsPopup .line { margin:8px 0; color:#073b4c; }
#videoPopup video { width:100%; height:auto; border-radius:8px; background:#000; }
.quiz-answers { margin-top:12px; display:flex; flex-direction:column; gap:8px; }
.quiz-answers button, .quiz-answers .submit-btn { width:100%; padding:10px; border-radius:8px; border:none; cursor:pointer; font-weight:600; }
.checkbox-row { display:flex; flex-direction:column; gap:6px; margin-top:8px; text-align:left; }

/* Gradient animation outro */
@keyframes bgFade {
  0% { background: linear-gradient(#6bd5ff, #b9f1ff); }
  50% { background: linear-gradient(#b9f1ff, #6bd5ff); }
  100% { background: linear-gradient(#6bd5ff, #b9f1ff); }
}
</style>
</head>
<body>

<!-- === NHáº C Ná»€N === -->
<audio id="bgMusic" loop>
  <source src="music.mp3" type="audio/mpeg">
</audio>

<!-- === Ã‚M THANH ÄÃšNG â€“ SAI === -->
<audio id="correctSound">
  <source src="correct.mp3" type="audio/mpeg">
</audio>

<audio id="wrongSound">
  <source src="wrong.mp3" type="audio/mpeg">
</audio>

<!-- INTRO -->
<div id="introContainer">
  <div id="introText"></div>
  <div id="nameBox">
    <label>Nháº­p tÃªn cá»§a báº¡n:</label><br>
    <input id="playerName" type="text"><br>
    <button onclick="startGame()">Báº¯t Ä‘áº§u</button>
  </div>
</div>

<!-- NÃšT HIá»‚N THá»Š HÆ¯á»šNG DáºªN -->
<div style="text-align:center; margin-top:10px;">
  <button id="towerGuideBtn" style="padding:10px 16px; background:#00a8ff; color:#fff; border:none; border-radius:8px; cursor:pointer; font-weight:600;" onclick="openTowerGuide()">HÆ°á»›ng dáº«n ThÃ¡p</button>
</div>

<!-- POPUP HÆ¯á»šNG DáºªN -->
<div id="towerGuidePopup" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:50; justify-content:center; align-items:center; padding:20px; display:flex;">
  <div style="background:#fff; max-width:700px; width:100%; border-radius:12px; padding:20px; box-shadow:0 12px 35px rgba(0,0,0,0.35); overflow:auto; max-height:80vh;">
    <h2 style="margin-top:0; color:#0077c8;">HÆ°á»›ng dáº«n sá»­ dá»¥ng â€” 4 tÃ²a thÃ¡p</h2>
    <p><strong>Má»¥c tiÃªu:</strong> Tráº£ lá»i Ä‘Ãºng cÃ¡c cÃ¢u há»i Ä‘á»ƒ nÃ¢ng cáº¥p 4 tÃ²a thÃ¡p lÃªn má»©c tá»‘i Ä‘a.</p>
    <ol style="text-align:left; padding-left:18px;">
      <li><strong>Nháº­p tÃªn:</strong> Nháº­p tÃªn rá»“i nháº¥n <em>Báº¯t Ä‘áº§u</em>.</li>
      <li><strong>Chá»n tÃ²a thÃ¡p:</strong> Nháº¥p vÃ o tÃ²a thÃ¡p báº¡n muá»‘n tráº£ lá»i.</li>
      <li><strong>Tráº£ lá»i 1 cÃ¢u:</strong> Má»—i thÃ¡p chá»‰ cÃ³ 1 cÃ¢u há»i, chá»n 1 trong 3 Ä‘Ã¡p Ã¡n.</li>
      <li><strong>NÃ¢ng cáº¥p :</strong> Náº¿u Ä‘Ãºng, thÃ¡p sáº½ Ä‘áº¡t má»©c tá»‘i Ä‘a ngay.</li>
      <li><strong>Thá»­ láº¡i khi sai:</strong> Náº¿u sai, cÃ³ thÃ´ng bÃ¡o, báº¡n cÃ³ thá»ƒ thá»­ láº¡i.</li>
      <li><strong>HoÃ n thÃ nh trÃ² chÆ¡i:</strong> Khi cáº£ 4 thÃ¡p Ä‘á»u Ä‘áº¡t má»©c tá»‘i Ä‘a, mÃ n khÃ¡c sáº½ xuáº¥t hiá»‡n.</li>
    </ol>
    <p style="font-size:13px; color:#555; margin-top:10px;">Báº¡n cÃ³ thá»ƒ lÃ m thÃ¡p theo báº¥t ká»³ thá»© tá»± nÃ o. TrÃ² chÆ¡i sáº½ Ä‘áº¿m thá»i gian báº¡n chÆ¡i khi báº¡n nháº¥n báº¯t Ä‘áº§u.</p>
    <div style="text-align:right; margin-top:12px;">
      <button style="padding:10px 16px; background:#ff6b6b; color:#fff; border:none; border-radius:8px; cursor:pointer; font-weight:600;" onclick="closeTowerGuide()">ÄÃ³ng</button>
    </div>
  </div>
</div>

<!-- HÆ°á»›ng dáº«n trÃªn thÃ¡p -->
<div id="towerGuide" style="display:none;">
  Chá»n vÃ o má»—i tÃ²a thÃ¡p â€” má»—i tÃ²a tÆ°á»£ng trÆ°ng cho má»™t tÃ i khoáº£n cá»§a Minh. Nháº¥p vÃ o thÃ¡p Ä‘á»ƒ Ä‘áº·t máº­t kháº©u máº¡nh!
</div>

<!-- GAME -->
<h1 id="gameTitle">Mini Game: Chá»n máº­t kháº©u máº¡nh Ä‘á»ƒ nÃ¢ng cáº¥p thÃ¡p</h1>
<div class="game-area" id="gameArea">
  <div class="tower" id="tower1"><div class="roof"></div></div>
  <div class="tower" id="tower2"><div class="roof"></div></div>
  <div class="tower" id="tower3"><div class="roof"></div></div>
  <div class="tower" id="tower4"><div class="roof"></div></div>
  <div class="character" id="character">ğŸ˜Š</div>
</div>

<!-- POPUP -->
<div class="popup" id="popup">
  <h2 id="questionTitle">Chá»n máº­t kháº©u</h2>
  <div id="answers"></div>
</div>

<!-- POPUP CUá»I THÃP -->
<div class="popup" id="finalPopup">
  <h2>ChÃºc má»«ng!</h2>
  <p>Báº¡n Ä‘Ã£ giÃºp Minh Ä‘áº·t máº­t kháº©u máº¡nh, nhÆ°ng Ä‘á»ƒ sau nÃ y Minh khÃ´ng Ä‘áº·t máº­t kháº©u yáº¿u ná»¯a, báº¡n nÃªn cho Minh 1 sá»‘ lá»i khuyÃªn.</p>
  <button id="nextGameBtn">ÄÆ°á»£c thÃ´i</button>
</div>

<!-- POPUP Lá»œI KHUYÃŠN -->
<div class="popup" id="advicePopup">
  <h2 id="adviceQuestion">CÃ¢u há»i</h2>
  <div id="adviceAnswers"></div>
</div>

<!-- OUTRO -->
<div id="outroScreen">
  <h1 id="outroTitle" style="opacity:0; transition:opacity 1s;">Thank for playing!</h1>
  <p id="outroText" style="opacity:0; transition:opacity 1s;">Báº¡n Ä‘Ã£ hoÃ n thÃ nh trÃ² chÆ¡i.HÃ£y chia sáº» cho báº¡n bÃ¨ cÃ¹ng chÆ¡i nhÃ©.Háº¹n gáº·p láº¡i!Game Ä‘Æ°á»£c táº¡o bá»Ÿi HÆ°ng vÃ  QuÃ¢n.</p>
  <div id="outroCharacter" style="width:80px; height:80px; background:#ffeb3b; border-radius:50%; margin-top:30px; display:flex; justify-content:center; align-items:center; font-size:36px; opacity:0; transition:opacity 1s;">ğŸ˜Š</div>
</div>

<!-- ======= NEW: CONGRATS + VIDEO + QUIZ POPUPS (THÃŠM Má»šI, KHÃ”NG Sá»¬A GAME) ======= -->

<!-- Congratulation popup (shown when showOutro is called) -->
<div class="popup" id="congratsPopup" style="display:none; width:420px;">
  <h2>ChÃºc má»«ng â€” Báº¡n Ä‘Ã£ hoÃ n thÃ nh trÃ² chÆ¡i!</h2>
  <p class="line">Báº¡n Ä‘Ã£ giÃºp Minh cáº£i thiá»‡n báº£o máº­t. Xem video ngáº¯n Ä‘á»ƒ hiá»ƒu thÃªm tÃ¬nh huá»‘ng lá»«a Ä‘áº£o.</p>
  <button id="watchVideoBtn">Xem video hÆ°á»›ng dáº«n</button>
  <button id="skipToQuizBtn" style="background:#ff6b6b; margin-top:8px;">Bá» qua video â€” Tráº£ lá»i cÃ¢u há»i</button>
</div>

<!-- Video popup -->
<div class="popup" id="videoPopup" style="display:none; width:760px; max-width:95vw;">
  <h2>Video minh há»a tÃ¬nh huá»‘ng lá»«a Ä‘áº£o</h2>
  <video id="lessonVideo" controls>
    <source src="video.mp4" type="video/mp4">
    TrÃ¬nh duyá»‡t cá»§a báº¡n khÃ´ng há»— trá»£ tháº» video.
  </video>
  <button id="skipVideoBtn" style="margin-top:10px; background:#ff6b6b;">Bá» qua video</button>
</div>

<!-- Quiz popup (4 cÃ¢u há»i) -->
<div class="popup" id="quizPopup" style="display:none; width:600px; max-width:95vw;">
  <h2 id="quizTitle">BÃ i kiá»ƒm tra nhanh</h2>
  <div id="quizBody" style="margin-top:8px; text-align:left;">
    <!-- Ná»™i dung cÃ¢u há»i sáº½ Ä‘Æ°á»£c chÃ¨n báº±ng JS -->
  </div>
  <div style="margin-top:12px;">
    <button id="nextQuizBtn" style="background:#00a8ff;">Tiáº¿p tá»¥c</button>
  </div>
</div>
<div id="activity3Screen" style="display:none; flex-direction:column; justify-content:center; align-items:center; height:100vh; padding:20px; text-align:center; background:#87CEFA;">
  <h1>Hoáº¡t Ä‘á»™ng 3</h1>
  <p style="font-size:20px; color:#0077c8; margin-bottom:15px;">
    Lan Ä‘ang lÃ m poster tuyÃªn truyá»n an toÃ n máº¡ng nhÆ°ng báº¡n áº¥y chá»‰ má»›i xong pháº§n trÃ¬nh bÃ y, báº¡n hÃ£y giÃºp báº¡n áº¥y pháº§n ná»™i dung nhÃ©.
  </p>
  <button id="startQuizBtn" style="margin-top:20px; padding:10px 16px; background:#00a8ff; color:#fff; border:none; border-radius:8px; cursor:pointer;">OK</button>
</div>

<div id="quiz" style="display:none; flex-direction:column; align-items:center; gap:12px; margin-top:20px;">
  <div id="question" style="font-size:20px; font-weight:600;"></div>
  <div id="options" style="display:flex; flex-direction:column; gap:10px;"></div>
</div>

<div id="poster" style="display:none; margin-top:20px; font-size:18px;">
  <img src="posternhÃ©.png" alt="Poster" style="max-width:90%; border-radius:12px;">
</div>
<!-- ========================================================================== -->

<script>
// --- INTRO ---
const introLines=["Báº¡n lÃ  1 nhÃ  thÃ¡m hiá»ƒm internet...","Trong lÃºc thÃ¡m hiá»ƒm báº¡n gáº·p Minh â€“ 1 ngÆ°á»i Ä‘ang bá»‹ nhá»¯ng tÃªn hacker Ä‘Ã¡nh cáº¯p thÃ´ng tin...","Nhiá»‡m vá»¥ cá»§a báº¡n lÃ  giÃºp Minh Ä‘áº·t láº¡i máº­t kháº©u!"];
let lineIndex=0,charIndex=0;
const introText=document.getElementById("introText");
const nameBoxEl=document.getElementById("nameBox");

function typeIntro(){
  introText.innerHTML = ""; 
  lineIndex=0; charIndex=0;

  function typing(){
    if(lineIndex<introLines.length){
      if(charIndex<introLines[lineIndex].length){
        introText.innerHTML+=introLines[lineIndex].charAt(charIndex);
        charIndex++;
        setTimeout(typing,40);
      } else {
        introText.innerHTML+="<br><br>";
        lineIndex++; charIndex=0;
        setTimeout(typing,500);
      }
    } else {
      nameBoxEl.style.display="block";
    }
  }

  typing();
}

// KHÃ”NG CHáº Y INTRO KHI LOAD TRANG Ná»®A
// window.onload = typeIntro;

// --- NHáº C ---
const bgMusic=document.getElementById("bgMusic");
const correctSound=document.getElementById("correctSound");
const wrongSound=document.getElementById("wrongSound");
let bgStart=false;

document.addEventListener("click",()=>{
  if(!bgStart){
    bgMusic.volume=0.5;
    bgMusic.play().catch(()=>{});
    bgStart=true;
  }
});

// --- GAME DATA ---
const towersData = {
  tower1: [{question: "Chá»n máº­t kháº©u máº¡nh.", answers: [{ text: "12345", correct: false },{ text: "Huy3#2025", correct: true },{ text: "abcdef", correct: false }]}],
  tower2: [{question: "Chá»n máº­t kháº©u cÃ³ sá»‘ vÃ  chá»¯ viáº¿t hoa.", answers: [{ text: "Pass1234", correct: true },{ text: "abcdefg", correct: false },{ text: "Password", correct: false }]}],
  tower3: [{question: "Chá»n máº­t kháº©u cÃ³ chá»¯ hoa, chá»¯ thÆ°á»ng,sá»‘ vÃ  kÃ½ tá»± Ä‘áº·c biá»‡t.", answers: [{ text: "ABCDEFG", correct: false },{ text: "1234567", correct: false },{ text: "Hoctap@1235", correct: true }]}],
  tower4: [{question: "Chá»n máº­t kháº©u Ä‘á»§ 8 kÃ½ tá»± trá»Ÿ lÃªn.", answers: [{ text: "12a424a", correct: false },{ text: "SafePassw1", correct: true },{ text: "chamchi@!", correct: false }]}]
};

const towers=document.querySelectorAll('.tower');
const popup=document.getElementById('popup');
const questionTitle=document.getElementById('questionTitle');
const answersDiv=document.getElementById('answers');
const character=document.getElementById('character');
const gameArea=document.getElementById('gameArea');
const gameTitle=document.getElementById('gameTitle');
const towerGuide=document.getElementById('towerGuide');
const finalPopup=document.getElementById('finalPopup');
const advicePopup=document.getElementById('advicePopup');
const adviceQuestionEl=document.getElementById('adviceQuestion');
const adviceAnswersDiv=document.getElementById('adviceAnswers');
const outroScreen=document.getElementById('outroScreen');
const outroChar=document.getElementById('outroCharacter');

let currentTower=null;
let currentLevel={tower1:0,tower2:0,tower3:0,tower4:0};

function startGame(){
  const nameInput=document.getElementById('playerName').value;
  document.getElementById('introContainer').style.display="none";
  towerGuide.style.display="block";
  gameTitle.style.display="block";
  gameArea.style.display="flex";
}

towers.forEach(tower=>{
  tower.addEventListener('click',()=>{
    currentTower=tower.id;
    const rect=tower.getBoundingClientRect();
    const areaRect=gameArea.getBoundingClientRect();
    const x=rect.left-areaRect.left+rect.width/2-character.offsetWidth/2;
    const y=-character.offsetHeight;
    character.style.left=x+'px';
    character.style.top=y+'px';
    showTowerQuestion(currentTower);
  });
});

function showTowerQuestion(towerId){
  const level=currentLevel[towerId];
  if(level>=1){ checkAllTowersCompleted(); return; }
  const q=towersData[towerId][0];
  questionTitle.textContent=q.question;
  answersDiv.innerHTML="";
  q.answers.forEach(ans=>{
    const btn=document.createElement('button');
    btn.textContent=ans.text;
    btn.onclick=()=>checkTowerAnswer(ans.correct);
    answersDiv.appendChild(btn);
  });
  popup.style.display='block';
}

function checkTowerAnswer(isCorrect){
  if(isCorrect){
    correctSound.currentTime=0; correctSound.play();
    alert("Chá»n Ä‘Ãºng! ThÃ¡p Ä‘Æ°á»£c nÃ¢ng cáº¥p ğŸ‰");
    const towerEl=document.getElementById(currentTower);
    currentLevel[currentTower]=3;
    towerEl.classList.add("level3");
  } else { wrongSound.currentTime=0; wrongSound.play(); alert("Máº­t kháº©u yáº¿u, thá»­ láº¡i ğŸ˜¢"); }
  popup.style.display='none';
  checkAllTowersCompleted();
}

function checkAllTowersCompleted(){
  const allDone=Object.values(currentLevel).every(l=>l>=1);
  if(allDone){ finalPopup.style.display='block'; }
  
}


document.getElementById('nextGameBtn').onclick=()=>{ finalPopup.style.display='none'; showAdviceGame(); };

// ---- GAME Lá»œI KHUYÃŠN ----
const adviceQuestions=[
  {q:"Khi Ä‘áº·t máº­t kháº©u, báº¡n cáº§n ___ Ä‘á»ƒ báº£o máº­t tá»‘t hÆ¡n.",answers:[
    {text:"sá»­ dá»¥ng chá»¯ hoa, chá»¯ thÆ°á»ng, sá»‘ vÃ  kÃ½ tá»± Ä‘áº·c biá»‡t",correct:true},
    {text:"chá»‰ dÃ¹ng sá»‘",correct:false},
    {text:"dÃ¹ng tÃªn mÃ¬nh",correct:false}]},
  {q:"Máº­t kháº©u nÃªn cÃ³ Ã­t nháº¥t ___ kÃ½ tá»±.",answers:[
    {text:"4 kÃ½ tá»±",correct:false},
    {text:"8 kÃ½ tá»±",correct:true},
    {text:"2 kÃ½ tá»±",correct:false}]},
  {q:"KhÃ´ng nÃªn sá»­ dá»¥ng ___ trong máº­t kháº©u.",answers:[
    {text:"tÃªn ngÆ°á»i thÃ¢n hoáº·c ngÃ y sinh",correct:true},
    {text:"kÃ½ tá»± Ä‘áº·c biá»‡t",correct:false},
    {text:"chá»¯ vÃ  sá»‘",correct:false}]},
  {q:"NÃªn thay Ä‘á»•i máº­t kháº©u ___ Ä‘á»ƒ trÃ¡nh bá»‹ hack.",answers:[
    {text:"khÃ´ng bao giá»",correct:false},
    {text:"thÆ°á»ng xuyÃªn",correct:true},
    {text:"chá»‰ khi bá»‹ quÃªn",correct:false}]},
  {q:"KhÃ´ng nÃªn sá»­ dá»¥ng ___ giá»‘ng nhau cho nhiá»u tÃ i khoáº£n.",answers:[
    {text:"máº­t kháº©u",correct:true},
    {text:"email",correct:false},
    {text:"tÃªn Ä‘Äƒng nháº­p",correct:false}]}];

let adviceIndex=0;
function showAdviceGame(){ adviceIndex=0; showAdviceQuestion(); }
function showAdviceQuestion(){
  if(adviceIndex>=adviceQuestions.length){ advicePopup.style.display='none'; showOutro(); return; }
  const q=adviceQuestions[adviceIndex];
  adviceQuestionEl.textContent=q.q;
  adviceAnswersDiv.innerHTML="";
  q.answers.forEach(ans=>{
    const btn=document.createElement('button');
    btn.textContent=ans.text;
    btn.onclick=()=>{
      if(ans.correct){ correctSound.currentTime=0; correctSound.play(); alert("Chá»n Ä‘Ãºng! ğŸ‰"); adviceIndex++; }
      else{ wrongSound.currentTime=0; wrongSound.play(); alert("Sai, thá»­ láº¡i ğŸ˜¢"); }
      showAdviceQuestion();
    };
    adviceAnswersDiv.appendChild(btn);
  });
  advicePopup.style.display='block';
  
  }
  function startActivity3(){
  // áº¨n cÃ¡c mÃ n hÃ¬nh khÃ¡c
  gameArea.style.display='none';
  quizPopup.style.display='none';
  congratsPopup.style.display='none';
  videoPopup.style.display='none';
  outroScreen.style.display='none';
  
  // Hiá»ƒn thá»‹ mÃ n hÃ¬nh Hoáº¡t Ä‘á»™ng 3
  document.getElementById('activity3Screen').style.display='flex';
  
  // NÃºt tiáº¿p tá»¥c Ä‘á»ƒ qua outro
  document.getElementById('activity3NextBtn').onclick = () => {
    document.getElementById('activity3Screen').style.display='none';
    // Gá»i outro gá»‘c
    if(typeof originalShowOutro === 'function') originalShowOutro();
    else document.getElementById('outroScreen').style.display='flex';
  };
}

// Sá»­a finishQuizFlow Ä‘á»ƒ gá»i startActivity3 trÆ°á»›c outro
function finishQuizFlow(){
  quizPopup.style.display = 'none';
  congratsPopup.style.display = 'none';
  videoPopup.style.display = 'none';
  
  // Gá»i Hoáº¡t Ä‘á»™ng 3 trÆ°á»›c outro
  startActivity3();
}

// --- OUTRO ---
function showOutro(){
  advicePopup.style.display='none';
  gameArea.style.display='none';
  gameTitle.style.display='none';
  towerGuide.style.display='none';
  outroScreen.style.display='flex';
  setTimeout(()=>document.getElementById('outroTitle').style.opacity=1,100);
  setTimeout(()=>document.getElementById('outroText').style.opacity=1,1100);
  setTimeout(()=>outroChar.style.opacity=1,2100);
}

// --- HÆ¯á»šNG DáºªN THÃP ---
function openTowerGuide(){
  document.getElementById('towerGuidePopup').style.display='flex';
}

function closeTowerGuide(){
  document.getElementById('towerGuidePopup').style.display='none';
  typeIntro();  // << Báº®T Äáº¦U INTRO SAU KHI áº¤N ÄÃ“NG
}

// Hide poster when story shown
document.getElementById('storyOverlay').addEventListener('transitionstart',()=>{
  try{ document.getElementById('poster').style.display='none'; }catch(e){}
});

</script>

<!-- ======= APPENDED SCRIPT: chÃºc má»«ng â†’ video â†’ quiz (KHÃ”NG Sá»¬A GAME) ======= -->
<script>
/*
  LÆ¯U Ã: Ä‘oáº¡n nÃ y chá»‰ "thÃªm" chá»©c nÄƒng má»›i.
  - Khi hÃ m showOutro() Ä‘Æ°á»£c gá»i, nÃ³ sáº½ hiá»ƒn thá»‹ popup chÃºc má»«ng (mÃ¬nh ghi Ä‘Ã¨ hÃ m runtime).
  - Sau khi hoÃ n táº¥t quiz, hÃ m showOutro gá»‘c sáº½ Ä‘Æ°á»£c gá»i Ä‘á»ƒ hiá»ƒn thá»‹ outro ban Ä‘áº§u.
*/

// LÆ°u hÃ m showOutro gá»‘c
const originalShowOutro = window.showOutro;

// Náº¿u khÃ´ng tá»“n táº¡i hÃ m gá»‘c (trÆ°á»ng há»£p), Ä‘áº£m báº£o originalShowOutro lÃ  null
// (trong file gá»‘c, showOutro luÃ´n Ä‘Æ°á»£c Ä‘á»‹nh nghÄ©a nÃªn originalShowOutro sáº½ lÃ  function)
if (typeof originalShowOutro !== 'function') {
  // khÃ´ng cÃ³ hÃ m gá»‘c â€” define 1 hÃ m máº·c Ä‘á»‹nh an toÃ n
  window.showOutro = function(){
    document.getElementById('outroScreen').style.display='flex';
  };
} else {
  // GHI ÄÃˆ showOutro báº±ng 1 hÃ m má»›i, nhÆ°ng sáº½ gá»i originalShowOutro sau khi quiz xong
  window.showOutro = function(){
    // Hiá»‡n popup chÃºc má»«ng (má»›i)
    document.getElementById('congratsPopup').style.display = 'block';
  };
}

// DOM elements for new flow
const congratsPopup = document.getElementById('congratsPopup');
const watchVideoBtn = document.getElementById('watchVideoBtn');
const skipToQuizBtn = document.getElementById('skipToQuizBtn');
const videoPopup = document.getElementById('videoPopup');
const lessonVideo = document.getElementById('lessonVideo');
const skipVideoBtn = document.getElementById('skipVideoBtn');
const quizPopup = document.getElementById('quizPopup');
const quizBody = document.getElementById('quizBody');
const nextQuizBtn = document.getElementById('nextQuizBtn');

// Äá»‹nh nghÄ©a ná»™i dung 4 cÃ¢u há»i theo yÃªu cáº§u (má»™t sá»‘ cÃ¢u cho phÃ©p nhiá»u Ä‘Ã¡p Ã¡n)
const finalQuiz = [
  {
    id: 1,
    type: 'single', // single-choice
    q: 'CÃ¢u 1: ÄÃ¢u "KHÃ”NG" pháº£i lÃ  nguyÃªn nhÃ¢n khiáº¿n Minh bá»‹ lá»«a Ä‘áº£o qua máº¡ng?',
    options: [
      'Tin tÆ°á»Ÿng vÃ o báº¡n bÃ¨',
      'Háº¥p táº¥p, thiáº¿u suy nghÄ©',
      'VÃ¬ nhÃ  Minh giÃ u'
    ],
    correctIndex: 2 // "VÃ¬ nhÃ  Minh giÃ u" lÃ  Ä‘Ã¡p Ã¡n Ä‘Ãºng (khÃ´ng pháº£i nguyÃªn nhÃ¢n)
  },
  {
    id: 2,
    type: 'multi', // multiple-choice (chá»n táº¥t cáº£ thá»§ Ä‘oáº¡n Ä‘Ã£ dÃ¹ng)
    q: 'CÃ¢u 2: Äá»‘i tÆ°á»£ng lá»«a Ä‘áº£o Ä‘Ã£ sá»­ dá»¥ng nhá»¯ng thá»§ Ä‘oáº¡n nÃ o Ä‘á»ƒ khiáº¿n nhÃ¢n váº­t tin lÃ  tháº­t? (Chá»n nhá»¯ng cÃ¢u Ä‘Ãºng)',
    options: [
      'A. Giáº£ máº¡o tÃ i khoáº£n báº¡n bÃ¨ vÃ  nháº¯n tin vá»›i giá»ng Ä‘iá»‡u quen thuá»™c.',
      'B. Tiáº¿p cáº­n náº¡n nhÃ¢n lÃ m quen vÃ  dáº§n dáº§n trá»Ÿ thÃ nh báº¡n bÃ¨ Ä‘á»ƒ lá»«a Ä‘áº£o',
      'C. Há»‘i thÃºc nhÃ¢n váº­t thá»±c hiá»‡n nhanh Ä‘á»ƒ â€œkhÃ´ng bá» lá»¡ cÆ¡ há»™iâ€.'
    ],
    // Trong tÃ¬nh huá»‘ng mÃ´ táº£, cáº£ A, B, C Ä‘á»u lÃ  thá»§ Ä‘oáº¡n Ä‘Æ°á»£c sá»­ dá»¥ng â†’ nÃªn táº¥t cáº£ Ä‘á»u Ä‘Ãºng
    correctIndexes: [0,1,2]
  },
  {
    id: 3,
    type: 'multi',
    q: 'CÃ¢u 3: Sau khi bá»‹ lá»«a Ä‘áº£o, nhÃ¢n váº­t Ä‘Ã£ gáº·p pháº£i háº­u quáº£ gÃ¬? (Chá»n nhá»¯ng cÃ¢u Ä‘Ãºng)',
    options: [
      'Máº¥t tiá»n',
      'Lá»™ thÃ´ng tin cÃ¡ nhÃ¢n, tÃ i khoáº£n máº¡ng xÃ£ há»™i bá»‹ chiáº¿m quyá»n.',
      'Bá»‹ Ä‘e dá»a, lÃ m phiá»n hoáº·c tiáº¿p tá»¥c bá»‹ nháº¯n tin lá»«a Ä‘áº£o.'
    ],
    // Táº¥t cáº£ Ä‘á»u lÃ  háº­u quáº£ kháº£ dÄ© â†’ coi cáº£ 3 lÃ  Ä‘Ãºng
    correctIndexes: [0,1,2]
  },
  {
    id: 4,
    type: 'multi',
    q: 'CÃ¢u 4: ThÃ´ng Ä‘iá»‡p cá»§a Ä‘oáº¡n video trÃªn lÃ  gÃ¬? (Chá»n táº¥t cáº£ cÃ¢u Ä‘Ãºng)',
    options: [
      'KhÃ´ng nÃªn tin tÆ°á»Ÿng tuyá»‡t Ä‘á»‘i vÃ o báº¥t ká»³ ai trÃªn máº¡ng, ká»ƒ cáº£ ngÆ°á»i quen.',
      'Internet luÃ´n an toÃ n nÃªn cÃ³ thá»ƒ thoáº£i mÃ¡i chia sáº» thÃ´ng tin cÃ¡ nhÃ¢n',
      'Cáº£nh giÃ¡c vá»›i Ä‘Æ°á»ng link, quÃ  táº·ng, Æ°u Ä‘Ã£i Ä‘Æ°á»£c gá»­i Ä‘á»™t ngá»™t.'
    ],
    // ÄÃ¡p Ã¡n Ä‘Ãºng: 1 vÃ  3 (khuyáº¿n cÃ¡o cáº£nh giÃ¡c; cÃ¢u 2 sai)
    correctIndexes: [0,2]
  }
];

let quizIndex = 0;

// HÃ m hiá»ƒn thá»‹ cÃ¢u há»i quiz hiá»‡n táº¡i
function renderQuizQuestion(){
  const item = finalQuiz[quizIndex];
  quizBody.innerHTML = '';
  const title = document.createElement('div');
  title.style.fontWeight = '700';
  title.style.marginBottom = '8px';
  title.textContent = item.q;
  quizBody.appendChild(title);

  if(item.type === 'single'){
    const wrap = document.createElement('div');
    wrap.className = 'quiz-answers';
    item.options.forEach((opt, i) => {
      const btn = document.createElement('button');
      btn.textContent = opt;
      btn.onclick = () => {
        // kiá»ƒm tra
        if(i === item.correctIndex){
          correctSound.currentTime = 0; correctSound.play();
          alert('ChÃ­nh xÃ¡c! ğŸ‰');
          quizIndex++;
          if(quizIndex >= finalQuiz.length){
            finishQuizFlow();
          } else {
            renderQuizQuestion();
          }
        } else {
          wrongSound.currentTime = 0; wrongSound.play();
          alert('Sai rá»“i, thá»­ láº¡i nhÃ© ğŸ˜¢');
        }
      };
      wrap.appendChild(btn);
    });
    quizBody.appendChild(wrap);
    // nÃºt next áº©n vá»›i cÃ¢u single (báº¥m Ä‘Ã¡p Ã¡n sáº½ tá»± chuyá»ƒn)
    nextQuizBtn.style.display = 'none';
  } else if(item.type === 'multi'){
    // hiá»ƒn thá»‹ checkbox + nÃºt submit
    const box = document.createElement('div');
    box.className = 'checkbox-row';
    item.options.forEach((opt, i) => {
      const label = document.createElement('label');
      const cb = document.createElement('input');
      cb.type = 'checkbox';
      cb.dataset.idx = i;
      cb.style.marginRight = '8px';
      label.appendChild(cb);
      const span = document.createElement('span');
      span.textContent = opt;
      label.appendChild(span);
      box.appendChild(label);
    });
    quizBody.appendChild(box);

    // show submit button
    nextQuizBtn.style.display = 'inline-block';
    nextQuizBtn.textContent = 'Ná»™p Ä‘Ã¡p Ã¡n';
    // Ä‘áº£m báº£o listener khÃ´ng bá»‹ Ä‘Äƒng kÃ½ nhiá»u láº§n
    nextQuizBtn.onclick = () => {
      const checked = Array.from(box.querySelectorAll('input[type="checkbox"]:checked')).map(n=>parseInt(n.dataset.idx));
      // sort for comparison
      checked.sort((a,b)=>a-b);
      const correct = item.correctIndexes.slice().sort((a,b)=>a-b);
      // compare arrays
      if(checked.length === correct.length && checked.every((v,i)=>v === correct[i])){
        correctSound.currentTime = 0; correctSound.play();
        alert('ChÃ­nh xÃ¡c! ğŸ‰');
        quizIndex++;
        if(quizIndex >= finalQuiz.length){
          finishQuizFlow();
        } else {
          renderQuizQuestion();
        }
      } else {
        wrongSound.currentTime = 0; wrongSound.play();
        alert('ChÆ°a chÃ­nh xÃ¡c. HÃ£y kiá»ƒm tra láº¡i vÃ  thá»­ láº¡i nhÃ© ğŸ˜¢');
      }
    };
  }
}

// HoÃ n táº¥t quiz â†’ gá»i outro gá»‘c Ä‘á»ƒ hiá»ƒn thá»‹ mÃ n outro cÅ©
function startActivity3(){
  // áº¨n cÃ¡c mÃ n hÃ¬nh khÃ¡c
  gameArea.style.display='none';
  quizPopup.style.display='none';
  congratsPopup.style.display='none';
  videoPopup.style.display='none';
  outroScreen.style.display='none';
  
  // Hiá»ƒn thá»‹ mÃ n hÃ¬nh Hoáº¡t Ä‘á»™ng 3
  document.getElementById('activity3Screen').style.display='flex';
  
  // NÃºt tiáº¿p tá»¥c Ä‘á»ƒ qua outro
  document.getElementById('activity3NextBtn').onclick = () => {
    document.getElementById('activity3Screen').style.display='none';
    // Gá»i outro gá»‘c
    if(typeof originalShowOutro === 'function') originalShowOutro();
    else document.getElementById('outroScreen').style.display='flex';
  };
}

// Sá»­a finishQuizFlow Ä‘á»ƒ gá»i startActivity3 trÆ°á»›c outro
function finishQuizFlow(){
  quizPopup.style.display = 'none';
  congratsPopup.style.display = 'none';
  videoPopup.style.display = 'none';
  
  // Gá»i Hoáº¡t Ä‘á»™ng 3 trÆ°á»›c outro
  startActivity3();
}


const quizData = [
  { question: "Báº¡n nÃªn lÃ m gÃ¬ Ä‘á»ƒ báº£o vá»‡ máº­t kháº©u tÃ i khoáº£n cá»§a mÃ¬nh?", options: ["DÃ¹ng ngÃ y sinh", "Táº¡o máº­t kháº©u máº¡nh vÃ  khÃ´ng chia sáº»", "Viáº¿t ra giáº¥y", "DÃ¹ng 1 máº­t kháº©u cho táº¥t cáº£"], answer: 1 },
  { question: "Khi sá»­ dá»¥ng ná»n táº£ng trá»±c tuyáº¿n, báº¡n nÃªn lÃ m gÃ¬ Ä‘á»ƒ báº£o vá»‡ quyá»n riÃªng tÆ°?", options: ["KhÃ´ng Ä‘á»c chÃ­nh sÃ¡ch", "Chia sáº» thÃ´ng tin cÃ¡ nhÃ¢n", "Kiá»ƒm tra chÃ­nh sÃ¡ch vÃ  Ä‘iá»u chá»‰nh cÃ i Ä‘áº·t", "Chá»‰ Ä‘Äƒng thÃ´ng tin cÃ´ng ty"], answer: 2 },
  { question: "Khi nháº­n Ä‘Æ°á»£c Ä‘Æ°á»ng link láº¡, báº¡n nÃªn lÃ m gÃ¬?", options: ["Nháº¥n ngay", "Chia sáº» cho báº¡n bÃ¨", "KhÃ´ng nháº¥p vÃ  kiá»ƒm tra nguá»“n gá»­i", "Sao chÃ©p vÃ o MXH há»i Ã½ kiáº¿n"], answer: 2 },
  { question: "TrÆ°á»›c khi Ä‘Äƒng báº¥t cá»© ná»™i dung nÃ o lÃªn máº¡ng, báº¡n cáº§n chÃº Ã½ Ä‘iá»u gÃ¬?", options: ["Ná»™i dung hÃ i hÆ°á»›c", "Ná»™i dung an toÃ n, phÃ¹ há»£p, khÃ´ng gÃ¢y háº¡i", "CÃ³ nhiá»u lÆ°á»£t like", "TrÃ¹ng bÃ i ngÆ°á»i khÃ¡c"], answer: 1 }
];

let current = 0;

function showQuestion() {
  if(current >= quizData.length){
    document.getElementById("quiz").style.display = "none";
    document.getElementById("poster").style.display = "block"; // hiá»‡n poster
    return;
  }

  const q = quizData[current];
  document.getElementById("question").innerText = q.question;
  const optionsDiv = document.getElementById("options");
  optionsDiv.innerHTML = "";

  q.options.forEach((opt, i) => {
    const btn = document.createElement("button");
    btn.innerText = opt;
    btn.style.padding = "10px 16px";
    btn.style.borderRadius = "8px";
    btn.style.border = "none";
    btn.style.cursor = "pointer";
    btn.style.background = "#00a8ff";
    btn.style.color = "#fff";
    btn.style.fontWeight = "600";
    btn.style.margin = "5px";
    btn.onclick = () => checkAnswer(i);
    optionsDiv.appendChild(btn);
  });
}

function checkAnswer(selected){
  if(selected === quizData[current].answer){

    // ğŸ”ŠÃ‚m thanh Ä‘Ãºng
    correctSound.currentTime = 0;
    correctSound.play();

    current++;
    showQuestion();

  } else {

    // ğŸ”ŠÃ‚m thanh sai
    wrongSound.currentTime = 0;
    wrongSound.play();

    alert("Sai rá»“i, thá»­ láº¡i nhÃ©!");
  }
}

// Khi báº¯t Ä‘áº§u hoáº¡t Ä‘á»™ng 3
function startActivity3(){
  document.getElementById('activity3Screen').style.display='flex';
  current = 0;
  document.getElementById("quiz").style.display = "flex";
  document.getElementById("poster").style.display = "none";
  showQuestion();
}

// Báº¯t Ä‘áº§u quiz
showQuestion();

// Sá»± kiá»‡n cho nÃºt trÃªn popup chÃºc má»«ng
watchVideoBtn.onclick = () => {
  congratsPopup.style.display = 'none';
  // show video popup
  videoPopup.style.display = 'block';
  // reset video to start
  try { lessonVideo.currentTime = 0; } catch(e){}
  lessonVideo.play().catch(()=>{});
};

skipToQuizBtn.onclick = () => {
  congratsPopup.style.display = 'none';
  // Báº¯t Ä‘áº§u quiz trá»±c tiáº¿p
  quizIndex = 0;
  quizPopup.style.display = 'block';
  renderQuizQuestion();
};

// Sá»± kiá»‡n cho nÃºt bá» qua video
skipVideoBtn.onclick = () => {
  try { lessonVideo.pause(); } catch(e){}
  videoPopup.style.display = 'none';
  quizIndex = 0;
  quizPopup.style.display = 'block';
  renderQuizQuestion();
};

// Khi video káº¿t thÃºc â†’ báº¯t Ä‘áº§u quiz
lessonVideo.onended = () => {
  videoPopup.style.display = 'none';
  quizIndex = 0;
  quizPopup.style.display = 'block';
  renderQuizQuestion();
};

// ÄÃ³ng táº¥t cáº£ popup khi nháº¥n ra ngoÃ i (tuá»³ chá»n) â€” khÃ´ng báº¯t buá»™c
// (KhÃ´ng gáº¯n sá»± kiá»‡n Ä‘Ã³ng khi báº¥m ngoÃ i Ä‘á»ƒ trÃ¡nh vÃ´ tÃ¬nh Ä‘Ã³ng)

// === Táº M Dá»ªNG NHáº C Ná»€N KHI XEM VIDEO ===
(function(){
  try {
    const bgMusicEl = document.getElementById('bgMusic');
    const lessonVideoEl = document.getElementById('lessonVideo');
    const skipVideoBtnEl = document.getElementById('skipVideoBtn');

    if(!bgMusicEl || !lessonVideoEl || !skipVideoBtnEl) return;

    // Khi video báº¯t Ä‘áº§u phÃ¡t â†’ táº¡m dá»«ng nháº¡c ná»n
    lessonVideoEl.addEventListener('play', () => {
      try { bgMusicEl.pause(); } catch(e){}
    });

    // Khi video káº¿t thÃºc â†’ tiáº¿p tá»¥c nháº¡c ná»n
    lessonVideoEl.addEventListener('ended', () => {
      try { bgMusicEl.play().catch(()=>{}); } catch(e){}
    });

    // Khi ngÆ°á»i báº¥m "Bá» qua video" â†’ tiáº¿p tá»¥c nháº¡c ná»n
    skipVideoBtnEl.addEventListener('click', () => {
      try { bgMusicEl.play().catch(()=>{}); } catch(e){}
    });

  } catch(e){}
})();
function startActivity3() {
    // áº¨n Táº¤T Cáº¢ cÃ¡c mÃ n hÃ¬nh cÅ© trÆ°á»›c khi vÃ o hoáº¡t Ä‘á»™ng 3
    gameArea.style.display = 'none';
    gameTitle.style.display = 'none';
    towerGuide.style.display = 'none';
    finalPopup.style.display = 'none';
    popup.style.display = 'none';
    advicePopup.style.display = 'none';
    congratsPopup.style.display = 'none';
    videoPopup.style.display = 'none';
    quizPopup.style.display = 'none';
    outroScreen.style.display = 'none';

    // Hiá»‡n mÃ n hÃ¬nh Hoáº¡t Ä‘á»™ng 3
    document.getElementById('activity3Screen').style.display = 'flex';

    // Reset quiz con
    current = 0;
    document.getElementById("quiz").style.display = "none";
    document.getElementById("poster").style.display = "none";
}

function endActivity3(){
  // áº¨n Hoáº¡t Ä‘á»™ng 3
  document.getElementById('activity3Screen').style.display = 'none';
  // Tiáº¿p tá»¥c outro gá»‘c
  showOutro();
}
// Gáº¯n sá»± kiá»‡n cho nÃºt OK
document.getElementById('startQuizBtn').onclick = () => {
    // áº¨n mÃ n hÃ¬nh hoáº¡t Ä‘á»™ng 3
    document.getElementById('activity3Screen').style.display = 'none';
    // Báº¯t Ä‘áº§u quiz hoáº·c outro tiáº¿p theo
    current = 0;
    document.getElementById("quiz").style.display = "flex";
    document.getElementById("poster").style.display = "none";
    showQuestion(); // gá»i hÃ m hiá»ƒn thá»‹ cÃ¢u há»i Ä‘áº§u tiÃªn
};
</script>


<!-- BEGIN: Poster congrats + story + super-quiz (added by assistant) -->
<style>
/* Poster congrats popup */
#posterCongratsOverlay, #confirmStoryOverlay, #storyOverlay, #superQuizPopup, #superQuizEnd {
  position: fixed; inset: 0; display: none; z-index: 9999; justify-content:center; align-items:center; background: rgba(0,0,0,0.6);
}
#posterCongrats, #confirmStory, #storyBox, #superQuizBox, #superQuizEndBox {
  background: #fff; border-radius:12px; padding:18px; max-width:900px; width:90%; box-shadow: 0 12px 35px rgba(0,0,0,0.4);
}
#posterCongrats .content { display:flex; gap:16px; align-items:center; }
#posterCongrats .left { flex: 0 0 40%; }
#posterCongrats .left img{ width:100%; height:auto; border-radius:8px; }
#posterCongrats .right { flex:1; text-align:left; }
#posterCongrats h2 { margin-top:0; color:#0077c8; }
.smallBtn { padding:10px 14px; border-radius:8px; border:none; cursor:pointer; font-weight:600; background:#00a8ff; color:#fff; }
.ghostBtn { background:#ff6b6b; }
.storyText { max-height:360px; overflow:auto; text-align:left; line-height:1.5; color:#073b4c; }
#superQuizBox .q { font-weight:700; margin-bottom:10px; }
#superQuizBox .options button { display:block; width:100%; margin:8px 0; padding:10px; border-radius:8px; border:none; cursor:pointer; background:#00a8ff; color:#fff; font-weight:600; }
#superQuizEndBox .animatedText { font-size:20px; line-height:1.6; text-align:center; padding:20px; }
</style>

<!-- Poster congrats overlay -->
<div id="posterCongratsOverlay" aria-hidden="true">
  <div id="posterCongrats" role="dialog">
    <div style="display:flex; justify-content:space-between; align-items:flex-start;">
      <h2>ChÃºc má»«ng â€” Báº¡n Ä‘Ã£ hoÃ n thÃ nh poster giÃºp Lan!</h2>
      <button onclick="closePosterCongrats()" style="background:transparent;border:none;font-size:20px;cursor:pointer;">âœ•</button>
    </div>
    <div class="content" style="margin-top:10px;">
      <div class="left"><img src="posternhÃ©.png" alt="Poster"></div>
      <div class="right">
        <p>Báº¡n Ä‘Ã£ hoÃ n thÃ nh poster giÃºp Lan. HÃ£y nháº¥n tiáº¿p tá»¥c Ä‘á»ƒ nghe má»™t cÃ¢u chuyá»‡n dá»±a trÃªn má»™t cÃ¢u chuyá»‡n cÃ³ tháº­t giÃºp hiá»ƒu thÃªm vá» cÃ¡ch káº» gian lá»£i dá»¥ng chá»‹ A.</p>
        <div style="margin-top:12px; display:flex; gap:8px;">
          <button class="smallBtn" id="pcContinueBtn">Tiáº¿p tá»¥c</button>
          <button class="smallBtn ghostBtn" onclick="closePosterCongrats()">ÄÃ³ng</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Confirm to view story -->
<div id="confirmStoryOverlay" aria-hidden="true">
  <div id="confirmStory">
    <h2>Báº¡n cÃ³ muá»‘n nghe chuyá»‡n cá»§a chá»‹ A (dá»±a trÃªn cÃ¢u chuyá»‡n cÃ³ tháº­t)?</h2>
    <p style="color:#333;">Nghe cÃ¢u chuyá»‡n sáº½ giÃºp báº¡n hiá»ƒu rÃµ cÃ¡ch lá»«a Ä‘áº£o váº­n hÃ nh. Báº¡n cÃ³ thá»ƒ <strong>Bá» qua</strong> vÃ  tráº£ lá»i cÃ¢u há»i ngay.</p>
    <div style="display:flex; gap:10px; margin-top:12px;">
      <button class="smallBtn" id="agreeStoryBtn">Äá»“ng Ã½ â€” Nghe chuyá»‡n</button>
      <button class="smallBtn ghostBtn" id="skipStoryBtn">Bá» qua â€” Tráº£ lá»i cÃ¢u há»i</button>
    </div>
  </div>
</div>

<!-- Story overlay -->
<div id="storyOverlay" aria-hidden="true">
  <div id="storyBox">
    <h2>Chuyá»‡n cá»§a chá»‹ A</h2>
    <div class="storyText" id="storyText">
      <p>Chá»‹ A lÃ m viá»‡c trong má»™t cá»­a hÃ ng nhá». Má»™t buá»•i chiá»u, chá»‹ nháº­n Ä‘Æ°á»£c cuá»™c gá»i tá»« má»™t ngÆ°á»i tá»± xÆ°ng lÃ  shipper. Anh ta nÃ³i ráº±ng Ä‘ang giá»¯ má»™t mÃ³n hÃ ng gá»­i cho chá»‹, nhÆ°ng chá»‹ A báº£o ráº±ng mÃ¬nh khÃ´ng há» Ä‘áº·t hÃ ng.</p>
      <p>Báº¡n Ä‘á»c tiáº¿p dÆ°á»›i...</p>
      <p>Ban Ä‘áº§u, chá»‹ A ráº¥t tá»‰nh tÃ¡o vÃ  tráº£ lá»i rÃµ rÃ ng: â€œTÃ´i khÃ´ng Ä‘áº·t gÃ¬ cáº£, anh giao nháº§m rá»“i.â€ Shipper váº«n khÄƒng khÄƒng ráº±ng Ä‘Ã¢y lÃ  hÃ ng â€œÄ‘áº·t trÆ°á»›câ€, yÃªu cáº§u chá»‹ pháº£i ra nháº­n Ä‘á»ƒ kiá»ƒm tra. Chá»‹ A tá»« chá»‘i thÃªm vÃ i láº§n nhÆ°ng anh ta liÃªn tá»¥c gá»i láº¡i, giá»ng ngÃ y cÃ ng gáº¥p gÃ¡p vÃ  khÃ³ chá»‹u.</p>
      <p>Má»™t lÃºc sau, shipper há»i má»™t cÃ¢u khiáº¿n chá»‹ báº¯t Ä‘áº§u lo láº¯ng: â€œChá»‹ cÃ³ biáº¿t trong kiá»‡n nÃ y cÃ³ hÃ ng cáº¥m khÃ´ng? Chá»‹ khÃ´ng kÃ½ nháº­n lÃ  chá»‹ chá»‹u trÃ¡ch nhiá»‡m Ä‘Ã³.â€ Chá»‹ A bá»‘i rá»‘i. Trong Ä‘áº§u chá»‹ chá»‰ cÃ²n láº¡i má»™t suy nghÄ©: â€œNáº¿u tháº­t lÃ  hÃ ng cáº¥m thÃ¬ sao? MÃ¬nh khÃ´ng nháº­n thÃ¬ cÃ³ bá»‹ nghi oan khÃ´ng?â€ DÃ¹ trÆ°á»›c Ä‘Ã³ ráº¥t tá»‰nh, chá»‹ báº¯t Ä‘áº§u sá»£. Anh shipper lá»£i dá»¥ng cáº£m giÃ¡c áº¥y, liÃªn tá»¥c thÃºc Ã©p: â€œNáº¿u chá»‹ khÃ´ng muá»‘n bá»‹ pháº¡t, tÃ´i sáº½ hÆ°á»›ng dáº«n chá»‹ lÃ m thá»§ tá»¥c xÃ¡c minh nhanh. Chá»‹ chá»‰ cáº§n chuyá»ƒn khoáº£n phÃ­ kiá»ƒm tra Ä‘á»ƒ há»‡ thá»‘ng Ä‘Ã³ng xÃ¡c nháº­n.â€</p>
      <p>Chá»‹ A má»Ÿ tÃ i khoáº£n nhÆ°ng trong tháº» khÃ´ng Ä‘á»§ tiá»n. Láº­p tá»©c, ngÆ°á»i kia tiáº¿p tá»¥c â€œchá»‰ dáº«nâ€: â€œKhÃ´ng sao, chá»‹ vay táº¡m ngÃ¢n hÃ ng online Ä‘i cho nhanh. TÃ´i gá»­i chá»‹ link nÃ¨, chá»‰ cáº§n báº¥m vÃ´ lÃ  vay Ä‘Æ°á»£c 25 triá»‡u. LÃ£i suáº¥t tháº¥p láº¯m, xá»­ lÃ½ 5 phÃºt.â€ KhÃ´ng ká»‹p suy nghÄ©, chá»‹ A nháº¥n vÃ o Ä‘Æ°á»ng link vay tiá»n. Trang web hiá»‡n lÃªn ráº¥t giá»‘ng ngÃ¢n hÃ ng tháº­t, cÃ³ logo, sá»‘ há»£p Ä‘á»“ng, tháº­m chÃ­ chá»¯ kÃ½ Ä‘iá»‡n tá»­. VÃ¬ Ä‘ang hoáº£ng loáº¡n, chá»‹ nháº­p toÃ n bá»™ thÃ´ng tin cÃ¡ nhÃ¢n, rá»“i chuáº©n bá»‹ báº¥m xÃ¡c nháº­n vay.</p>
      <p>ÄÃºng lÃºc Ä‘Ã³, cÃ´ Ä‘á»“ng nghiá»‡p Ä‘i ngang tháº¥y chá»‹ ngá»“i quÃ¡ lÃ¢u, máº·t tÃ¡i vÃ  tay run run nÃªn bÆ°á»›c Ä‘áº¿n há»i: â€œChá»‹ lÃ m gÃ¬ mÃ  cÄƒng tháº³ng váº­y?â€ Nghe chá»‹ A ká»ƒ láº¡i, cÃ´ láº­p tá»©c hiá»ƒu Ä‘Ã³ lÃ  lá»«a Ä‘áº£o chiáº¿m Ä‘oáº¡t tÃ i sáº£n. CÃ´ giáº­t láº¡i Ä‘iá»‡n thoáº¡i, táº¯t trang web giáº£ vÃ  yÃªu cáº§u chá»‹ A khÃ´ng chuyá»ƒn báº¥t ká»³ Ä‘á»“ng nÃ o, nhÆ°ng chá»‹ A Ä‘Ã£ vay tiá»n trÃªn má»™t app ngÃ¢n hÃ ng vay 25 triá»‡u vá»›i lÃ£i suáº¥t siÃªu cao. HÃªn chá»‰ má»™t click báº¥m vÃ o mÃ n hÃ¬nh ná»¯a thÃ´i lÃ , chá»‹ A Ä‘Ã£: Chuyá»ƒn tiá»n cho káº» lá»«a Ä‘áº£o. Nhá» cÃ³ ngÆ°á»i can thiá»‡p ká»‹p thá»i, chá»‹ A may máº¯n khÃ´ng máº¥t tiá»n. NhÆ°ng chá»‹ pháº£i gÃ¡nh mÃ³n lÃ£i khá»•ng lá»“.</p>
      <p>Sau sá»± viá»‡c, chá»‹ A nÃ³i trong run ráº©y: â€œLÃºc Ä‘áº§u tÃ´i tá»‰nh tÃ¡o láº¯mâ€¦ nhÆ°ng há» nÃ³i hÃ ng cáº¥m lÃ m tÃ´i sá»£ quÃ¡, máº¥t háº¿t lÃ½ trÃ­.â€</p>
    </div>
    <audio id="storyAudio" controls style="width:100%; margin-top:12px;">
      <source src="voice1.mp3" type="audio/mpeg">
      TrÃ¬nh duyá»‡t khÃ´ng há»— trá»£ audio.
    </audio>
    <div style="display:flex; gap:10px; margin-top:12px;">
      <button class="smallBtn" id="storyOkBtn">ÄÃ£ nghe xong â€” Qua cÃ¢u há»i</button>
      <button class="smallBtn ghostBtn" id="storySkipBtn">Bá» qua â€” Qua cÃ¢u há»i</button>
    </div>
  </div>
</div>

<!-- Super quiz popup -->
<div id="superQuizPopup" aria-hidden="true">
  <div id="superQuizBox">
    <h2>ğŸ§ ğŸ”¥ 5 CÃ¢u tráº¯c nghiá»‡m cáº¥p Ä‘á»™ SIÃŠU Tá»I THÆ¯á»¢NG</h2>
    <div id="superQuizContent">
      <!-- question/content injected by JS -->
    </div>
  </div>
</div>

<!-- Super quiz end popup with animated text (will play mp3) -->
<div id="superQuizEnd" aria-hidden="true">
  <div id="superQuizEndBox">
    <h2>Káº¿t thÃºc bÃ i kiá»ƒm tra</h2>
    <div class="animatedText" id="animatedText">Cáº£m Æ¡n báº¡n Ä‘Ã£ hoÃ n thÃ nh! HÃ£y luÃ´n cáº£nh giÃ¡c vÃ  chia sáº» kiáº¿n thá»©c nÃ y vá»›i ngÆ°á»i thÃ¢n.</div>
    <audio id="endAudio" style="display:none;">
      <source src="voice1.mp3" type="audio/mpeg">
    </audio>
    <div style="display:flex; justify-content:center; margin-top:12px;">
      <button class="smallBtn" onclick="closeSuperQuizEnd()">ÄÃ³ng</button>
    </div>
  </div>
</div>

<script>
// --- Wire up interception of Hoáº¡t Ä‘á»™ng 3 final question ---
// Keep reference to original checkAnswer if exists
const originalCheckAnswer = window.checkAnswer || null;

// Super-quiz data (using the 4 questions provided in the user's text)
const superQuiz = [
  {
    q: "1. Trong chuá»—i diá»…n biáº¿n, Ä‘Ã¢u lÃ  Ä‘iá»ƒm cho tháº¥y káº» lá»«a Ä‘áº£o khÃ´ng chá»‰ lá»£i dá»¥ng ná»—i sá»£ cá»§a chá»‹ A, mÃ  cÃ²n táº¡o ra má»™t khuÃ´n khá»• nháº­n thá»©c má»›i, khiáº¿n chá»‹ A Ä‘Ã¡nh giÃ¡ sai báº£n cháº¥t cá»§a sá»± viá»‡c?",
    options: ["A. Sá»­ dá»¥ng tá»« khÃ³a 'hÃ ng cáº¥m' Ä‘á»ƒ táº¡o sá»£ hÃ£i", "B. Ã‰p thá»i gian báº±ng cÃ¡ch gá»i liÃªn tá»¥c", "C. Chuyá»ƒn vai tá»« shipper â†’ ngÆ°á»i há»— trá»£ phÃ¡p lÃ½ mÃ  khÃ´ng cáº§n chá»©ng minh", "D. ÄÆ°a link vay tiá»n vá»›i giao diá»‡n ngÃ¢n hÃ ng tháº­t"],
    correct: 2 // index 2 = C
  },
  {
    q: "2. á» gÃ³c Ä‘á»™ nháº­n thá»©c sai lá»‡ch (cognitive distortion), chá»‹ A máº¯c pháº£i lá»—i nÃ o khiáº¿n báº£n thÃ¢n khÃ´ng cÃ²n giá»¯ Ä‘Æ°á»£c tiÃªu chÃ­ kiá»ƒm chá»©ng thÃ´ng tin?",
    options: ["A. Catastrophizing (phÃ³ng Ä‘áº¡i háº­u quáº£)", "B. Selective attention (chÃº Ã½ chá»n lá»c vá» phÃ­a rá»§i ro)", "C. External validation trap (phá»¥ thuá»™c hÆ°á»›ng dáº«n bÃªn ngoÃ i Ä‘á»ƒ quyáº¿t Ä‘á»‹nh)", "D. Confirmation bias (thiÃªn kiáº¿n xÃ¡c nháº­n)"],
    correct: 2 // C
  },
  {
    q: "3. Chi tiáº¿t nÃ o cho tháº¥y káº» lá»«a Ä‘áº£o Ä‘Ã£ cá»‘ tÃ¬nh táº¡o 'paradox lá»±a chá»n', khiáº¿n má»i Ä‘Æ°á»ng chá»‹ A chá»n Ä‘á»u dáº«n Ä‘áº¿n káº¿t quáº£ cÃ³ lá»£i cho tá»™i pháº¡m?",
    options: ["A. 'KhÃ´ng nháº­n hÃ ng thÃ¬ chá»‹ chá»‹u trÃ¡ch nhiá»‡m.'", "B. 'Chá»‰ cáº§n chuyá»ƒn phÃ­ Ä‘á»ƒ xÃ¡c minh.'", "C. 'KhÃ´ng Ä‘á»§ tiá»n thÃ¬ vay ngÃ¢n hÃ ng online Ä‘i cho nhanh.'", "D. 'Trang web giá»‘ng há»‡t ngÃ¢n hÃ ng tháº­t.'"],
    correct: 0 // A
  },
  {
    q: "4. PhÃ¢n tÃ­ch theo mÃ´ hÃ¬nh táº¥n cÃ´ng tÃ¢m lÃ½ 'táº§ng Ã¡p lá»±c kÃ©p', cÃ¢u nÃ³i nÃ o lÃ  sá»± káº¿t há»£p hoÃ n háº£o nháº¥t cá»§a Ä‘e dá»a + giáº£i phÃ¡p, khiáº¿n náº¡n nhÃ¢n bá»‹ cuá»‘n vÃ o guá»“ng?",
    options: ["A. 'Trong kiá»‡n cÃ³ hÃ ng cáº¥m, chá»‹ kÃ½ lÃ  chá»‹u trÃ¡ch nhiá»‡m.'", "B. 'KhÃ´ng muá»‘n bá»‹ pháº¡t thÃ¬ tÃ´i hÆ°á»›ng dáº«n thá»§ tá»¥c xÃ¡c minh nhanh.'", "C. 'TÃ i khoáº£n khÃ´ng Ä‘á»§ Ã ? Váº­y chá»‹ vay ngÃ¢n hÃ ng online Ä‘i cho láº¹.'", "D. 'Trang nÃ y xá»­ lÃ½ nhanh láº¯m, 5 phÃºt lÃ  xong.'"],
    correct: 1 // B
  },
  {
    q: "5. Chi tiáº¿t nÃ o cho tháº¥y chá»‹ A khÃ´ng cÃ²n hÃ nh Ä‘á»™ng dá»±a trÃªn thÃ´ng tin khÃ¡ch quan mÃ  dá»±a trÃªn â€œÃ¡p lá»±c khung cáº£nhâ€ (contextual compulsion)?",
    options: [
      "A. VÃ o website giáº£ máº¡o",
      "B. Nháº­p thÃ´ng tin cÃ¡ nhÃ¢n",
      "C. KhÃ´ng Ä‘á»c lÃ£i suáº¥t nhÆ°ng váº«n báº¥m vay",
      "D. Chuáº©n bá»‹ chuyá»ƒn tiá»n dÃ¹ biáº¿t mÃ¬nh khÃ´ng Ä‘áº·t hÃ ng"
    ],
    correct: 2 // index 2 = C
  }
];

let superIndex = 0;

function renderSuperQuestion(){
  const box = document.getElementById('superQuizContent');
  box.innerHTML = '';
  if(superIndex >= superQuiz.length){
    // finished
    document.getElementById('superQuizPopup').style.display = 'none';
    showSuperQuizEnd();
    return;
  }
  const item = superQuiz[superIndex];
  const qEl = document.createElement('div');
  qEl.className = 'q';
  qEl.textContent = item.q;
  box.appendChild(qEl);
  const opts = document.createElement('div');
  opts.className = 'options';
  item.options.forEach((opt, i) => {
    const btn = document.createElement('button');
    btn.textContent = opt;
    btn.onclick = () => {
      if(i === item.correct){
        try { document.getElementById('correctSound').currentTime = 0; document.getElementById('correctSound').play(); } catch(e){}
        alert('ChÃ­nh xÃ¡c!');
        superIndex++;
        renderSuperQuestion();
      } else {
        try { document.getElementById('wrongSound').currentTime = 0; document.getElementById('wrongSound').play(); } catch(e){}
        alert('Sai rá»“i, thá»­ láº¡i nhÃ©.');
      }
    };
    opts.appendChild(btn);
  });
  box.appendChild(opts);
}

function showSuperQuiz(){
  superIndex = 0;
  document.getElementById('superQuizPopup').style.display = 'flex';
  renderSuperQuestion();
}

function showSuperQuizEnd(){
  document.getElementById('superQuizEnd').style.display = 'flex';
  // play end audio and animate text (simple fade in)
  const endAudio = document.getElementById('endAudio');
  try { endAudio.currentTime = 0; endAudio.play().catch(()=>{}); } catch(e){}
  const t = document.getElementById('animatedText');
  t.style.opacity = 0;
  setTimeout(()=> t.style.transition = 'opacity 0.8s', 50);
  setTimeout(()=> t.style.opacity = 1, 150);
}

function closeSuperQuizEnd(){
  document.getElementById('superQuizEnd').style.display = 'none';
  // continue with original outro if available
  if(typeof originalShowOutro === 'function') originalShowOutro();
  else document.getElementById('outroScreen').style.display = 'flex';
}

// Show poster congrats overlay (called when user answers Q4 correctly in activity3)
function showPosterCongrats(){
  // hide activity3 quiz
  document.getElementById('quiz').style.display = 'none';
  document.getElementById('poster').style.display = 'block';
  document.getElementById('posterCongratsOverlay').style.display = 'flex';
}

// Close poster congrats
function closePosterCongrats(){
  document.getElementById('posterCongratsOverlay').style.display = 'none';
  // show poster and resume normal flow (poster already displayed)
  document.getElementById('poster').style.display = 'block';
  // Optionally show confirm directly
}

// Hook buttons
document.addEventListener('click', function(e){
  if(e.target && e.target.id === 'pcContinueBtn'){
    document.getElementById('posterCongratsOverlay').style.display = 'none';
    document.getElementById('confirmStoryOverlay').style.display = 'flex';
  }
  if(e.target && e.target.id === 'agreeStoryBtn'){
    document.getElementById('confirmStoryOverlay').style.display = 'none';
    document.getElementById('storyOverlay').style.display = 'flex';
    // autoplay audio if possible
    try { const a = document.getElementById('storyAudio'); a.currentTime = 0; a.play().catch(()=>{}); } catch(e){}
    // when audio ends, after 3s go to super quiz
    const a = document.getElementById('storyAudio');
    if(a){
      a.onended = function(){
        setTimeout(()=>{
          document.getElementById('storyOverlay').style.display = 'none';
          showSuperQuiz();
        }, 3000);
      };
    }
  }
  if(e.target && e.target.id === 'skipStoryBtn'){
    document.getElementById('confirmStoryOverlay').style.display = 'none';
    showSuperQuiz();
  }
  if(e.target && e.target.id === 'storyOkBtn'){
    // user clicked "ÄÃ£ nghe xong" button -> wait 3s then show super quiz
    try { document.getElementById('storyAudio').pause(); } catch(e){}
    document.getElementById('storyOverlay').style.display = 'none';
    setTimeout(()=> showSuperQuiz(), 3000);
  }
  if(e.target && e.target.id === 'storySkipBtn'){
    document.getElementById('storyOverlay').style.display = 'none';
    showSuperQuiz();
  }
});

// Override activity3 checkAnswer to intercept Q4 (index 3) correct answer
if(typeof window.checkAnswer === 'function'){
  const orig = window.checkAnswer.bind(window);
  window.checkAnswer = function(selected){
    try {
      // current and quizData are globals in original script
      if(typeof current !== 'undefined' && typeof quizData !== 'undefined'){
        // If this is the 4th question (index 3) and answer is correct -> show poster congrats flow
        if(current === 3 && selected === quizData[current].answer){
          // play correct sound
          try { document.getElementById('correctSound').currentTime = 0; document.getElementById('correctSound').play(); } catch(e){}
          // Show poster congrats overlay instead of normal flow
          showPosterCongrats();
          // increment current to mark question answered (so resume state consistent)
          current++;
          return;
        }
      }
    } catch(e){ console.error(e); }
    // fallback to original behavior
    return orig(selected);
  };
} else {
  // if checkAnswer not found, create a safe stub (unlikely)
  window.checkAnswer = function(selected){
    console.warn('checkAnswer not found - interaction fallback');
  };
}
</script>
<!-- END: Poster congrats + story + super-quiz -->


<script>
// === Story Highlight Sync ===
const storyTimings = [
  {start:0, end:13.5},
  {start:13.5, end:32.8},
  {start:32.8, end:70},
  {start:70, end:105},
  {start:105, end:142},
  {start:142, end:151}
];

const storyAudio = document.getElementById('storyAudio');
const storyParas = Array.from(document.querySelectorAll('#storyText p'));

function updateHighlight(){
  const t = storyAudio.currentTime;
  storyParas.forEach((p,i)=>{
    const seg = storyTimings[i];
    if(seg && t>=seg.start && t<seg.end){
      p.style.background = 'rgba(255,255,0,0.3)';
      p.style.transition = '0.3s';
    } else {
      p.style.background = 'transparent';
    }
  });
}

storyAudio.addEventListener('timeupdate', updateHighlight);

// Popup animations
document.querySelectorAll('#posterCongrats,#confirmStory,#storyBox,#superQuizBox').forEach(el=>{
  el.style.transform='scale(0.85)';
  el.style.opacity='0';
  el.style.transition='all 0.35s ease';
  const obs=new MutationObserver(()=>{
    if(getComputedStyle(el.parentElement).display!=='none'){
      requestAnimationFrame(()=>{
        el.style.transform='scale(1)';
        el.style.opacity='1';
      });
    }
  });
  obs.observe(el.parentElement,{attributes:true,attributeFilter:['style']});
});

// Darker overlays
document.querySelectorAll('#posterCongratsOverlay,#confirmStoryOverlay,#storyOverlay,#superQuizPopup,#superQuizEnd')
  .forEach(el=>el.style.background='rgba(0,0,0,0.75)');
</script>


<script>
// -- Ensure story audio uses relative path so it loads when opening file locally --
(function(){
  const audioEl = document.querySelector('#storyAudio source');
  if(audioEl && audioEl.getAttribute('src').startsWith('/mnt/data/')) {
    audioEl.setAttribute('src', 'voice1.mp3');
    // reload parent audio element if present
    const parent = document.getElementById('storyAudio');
    if(parent){ parent.load(); }
  }
})();

// -- Hide poster when overlays show, restore when all overlays hidden --
(function(){
  const posterEl = document.getElementById('poster');
  const overlays = [
    document.getElementById('posterCongratsOverlay'),
    document.getElementById('confirmStoryOverlay'),
    document.getElementById('storyOverlay'),
    document.getElementById('superQuizPopup'),
    document.getElementById('superQuizEnd')
  ].filter(Boolean);

  function anyOverlayVisible(){
    return overlays.some(o => o && getComputedStyle(o).display !== 'none');
  }

  // Observe changes to style/display of each overlay and hide/show poster accordingly
  overlays.forEach(o=>{
    if(!o) return;
    const obs = new MutationObserver(()=>{
      try{
        if(anyOverlayVisible()){
          if(posterEl) posterEl.style.display = 'none';
        } else {
          if(posterEl) posterEl.style.display = 'block';
        }
      }catch(e){}
    });
    obs.observe(o, { attributes: true, attributeFilter: ['style', 'class'] });
  });

  // Also intercept functions that show overlays via code paths (safer)
  const origShowPosterCongrats = window.showPosterCongrats;
  window.showPosterCongrats = function(){
    if(posterEl) posterEl.style.display='none';
    if(typeof origShowPosterCongrats === 'function') origShowPosterCongrats();
  };

  // When story overlay is shown through direct style changes, ensure audio plays
  const storyOverlay = document.getElementById('storyOverlay');
  const storyAudio = document.getElementById('storyAudio');
  if(storyOverlay){
    const obs2 = new MutationObserver(()=>{
      if(getComputedStyle(storyOverlay).display !== 'none'){
        try{
          if(posterEl) posterEl.style.display='none';
          // attempt to play audio
          if(storyAudio){
            storyAudio.currentTime = 0;
            const p = storyAudio.play();
            if(p && typeof p.catch === 'function'){ p.catch(()=>{}); }
          }
        }catch(e){}
      }
    });
    obs2.observe(storyOverlay, { attributes: true, attributeFilter: ['style', 'class'] });
  }

  // Buttons that close story overlay should restore poster when closed (safety)
  ['storyOkBtn','storySkipBtn','pcContinueBtn'].forEach(id=>{
    const btn = document.getElementById(id);
    if(btn){
      btn.addEventListener('click', ()=>{
        setTimeout(()=>{ if(posterEl) posterEl.style.display='block'; }, 250);
      });
    }
  });
})();
</script>


<script>
// --- Auto pause/resume background music when story popup opens/closes ---
(function(){
  const storyOverlay = document.getElementById('storyOverlay');
  const bg = document.getElementById('bgMusic');
  if(!storyOverlay || !bg) return;

  const obs = new MutationObserver(()=>{
    const visible = getComputedStyle(storyOverlay).display !== 'none';
    if(visible){
      try{ bg.pause(); }catch(e){}
    } else {
      try{ bg.play(); }catch(e){}
    }
  });
  obs.observe(storyOverlay, { attributes:true, attributeFilter:['style','class'] });
})();
</script>


<script>
// FIX 1 â€” Táº¯t hoÃ n toÃ n poster ná»n khi Ä‘ang á»Ÿ Hoáº¡t Ä‘á»™ng 3
(function(){
    const poster = document.getElementById("poster");

    const hidePosterWhenQuizRunning = () => {
        if (typeof current !== "undefined" && current < 4) {
            poster.style.display = "none";
        }
    };

    setInterval(hidePosterWhenQuizRunning, 300);
})();

// FIX 2 â€” XÃ³a hiá»‡u á»©ng sá»c Ä‘áº±ng sau popup/story
document.body.style.background = "#6bd5ff";
document.body.style.overflow = "hidden";
</script>


<script>
// FIX chuáº©n: Khi popup story/confirm/superquiz má»Ÿ â†’ áº©n poster á»Ÿ sau
(function(){
    const overlays = [
        "confirmStoryOverlay",
        "storyOverlay",
        "superQuizPopup",
        "superQuizEnd"
    ];

    function hidePosterBehind() {
        const posterImgs = document.querySelectorAll('#posterCongrats img, #poster img');
        const someOverlayOpen = overlays.some(id => {
            const el = document.getElementById(id);
            return el && getComputedStyle(el).display !== "none";
        });

        posterImgs.forEach(img => {
            img.style.visibility = someOverlayOpen ? "hidden" : "visible";
        });
    }

    setInterval(hidePosterBehind, 200);
})();
</script>


<script>
// === FIX 1: Táº®T HOÃ€N TOÃ€N Tá»° PHÃT NHáº C á» ÄOáº N CUá»I ===
document.addEventListener("DOMContentLoaded", ()=>{
    const endAudio = document.getElementById("endAudio");
    if(endAudio){
        endAudio.autoplay = false;
        endAudio.pause();
        endAudio.play = ()=>{}; 
    }
});
if(document.getElementById("storyAudio")){
    document.getElementById("storyAudio").onended = null;
}

// === FIX 2: LÃ m highlight chá»¯ vÃ ng cháº¡y mÆ°á»£t ===
(function(){
    const storyAudio = document.getElementById("storyAudio");
    const paras = Array.from(document.querySelectorAll("#storyText p"));
    const timings = window.storyTimings || [];

    function updateFast(){
        const t = storyAudio.currentTime;
        paras.forEach((p,i)=>{
            const seg = timings[i];
            if(seg && t >= seg.start && t < seg.end){
                p.style.background = "rgba(255,255,0,0.3)";
            } else {
                p.style.background = "transparent";
            }
        });
    }

    if(storyAudio){
        setInterval(updateFast, 80); 
    }
})();

// === FIX 3: ThÃªm CHÃ‚N cho cÃ¡c TÃ’A THÃP, khÃ´ng sá»­a game ===
(function(){
    const area = document.getElementById("gameArea");
    if(area){
        const towers = document.querySelectorAll(".tower");
        towers.forEach(t=>{
            const base = document.createElement("div");
            base.style.width = "100%";
            base.style.height = "20px";
            base.style.background = "rgba(0,0,0,0.25)";
            base.style.borderRadius = "0 0 12px 12px";
            base.style.marginTop = "8px";
            t.appendChild(base);
        });
    }
})();
</script>


<script>
// Disable yellow highlight in story
(function(){
    const storyAudio = document.getElementById("storyAudio");
    const paras = document.querySelectorAll("#storyText p");
    paras.forEach(p => p.style.background = "transparent");
    if (storyAudio){ storyAudio.ontimeupdate = null; }
    if (window.storyHighlightInterval){ clearInterval(window.storyHighlightInterval); }
    window.updateHighlight = function(){};
})();
</script>


<style>
body {
    background-attachment: fixed !important;
    background-position: center bottom !important;
}
</style>





<script>
// Fully disable highlight
window.updateHighlight = function(){};
document.querySelectorAll("#storyText p").forEach(p=> p.style.background = "transparent");
if (window.storyHighlightInterval) clearInterval(window.storyHighlightInterval);
</script>


<script>
// Stop story audio when skipping
document.addEventListener("DOMContentLoaded", ()=>{
  const a=document.getElementById("storyAudio");
  const ids=["skipStoryBtn","storySkipBtn"];
  ids.forEach(id=>{
    const b=document.getElementById(id);
    if(b){
      b.addEventListener("click", ()=>{
        if(a){ a.pause(); a.currentTime=0; }
      });
    }
  });
});
</script>


<style>
#storyText p {
    background: transparent !important;
}
</style>

<script>
// Hard-disable highlight
window.updateHighlight = function(){};
if (window.storyHighlightInterval) clearInterval(window.storyHighlightInterval);

// Remove any background color that may be applied later
document.addEventListener("DOMContentLoaded", ()=>{
    document.querySelectorAll("#storyText p").forEach(p=>{
        p.style.background = "transparent";
    });
});
</script>

</body>
</html>
